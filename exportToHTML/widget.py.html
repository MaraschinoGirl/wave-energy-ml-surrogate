<html>
<head>
<title>widget.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #7a7e85;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.ln { color: #4b5059; font-weight: normal; font-style: normal; }
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
widget.py</font>
</center></td></tr></table>
<pre><a name="l1"><span class="ln">1    </span></a>
<a name="l2"><span class="ln">2    </span></a><span class="s1"># Copyright (c) Jupyter Development Team.</span>
<a name="l3"><span class="ln">3    </span></a><span class="s1"># Distributed under the terms of the Modified BSD License.</span>
<a name="l4"><span class="ln">4    </span></a>
<a name="l5"><span class="ln">5    </span></a><span class="s2">&quot;&quot;&quot;Base Widget class.  Allows user to create widgets in the back-end that render 
<a name="l6"><span class="ln">6    </span></a>in the Jupyter notebook front-end. 
<a name="l7"><span class="ln">7    </span></a>&quot;&quot;&quot;</span>
<a name="l8"><span class="ln">8    </span></a><span class="s3">import </span><span class="s0">os</span>
<a name="l9"><span class="ln">9    </span></a><span class="s3">import </span><span class="s0">sys</span>
<a name="l10"><span class="ln">10   </span></a><span class="s3">import </span><span class="s0">typing</span>
<a name="l11"><span class="ln">11   </span></a><span class="s3">from </span><span class="s0">contextlib </span><span class="s3">import </span><span class="s0">contextmanager</span>
<a name="l12"><span class="ln">12   </span></a><span class="s3">from </span><span class="s0">collections</span><span class="s4">.</span><span class="s0">abc </span><span class="s3">import </span><span class="s0">Iterable</span>
<a name="l13"><span class="ln">13   </span></a><span class="s3">from </span><span class="s0">IPython </span><span class="s3">import </span><span class="s0">get_ipython</span>
<a name="l14"><span class="ln">14   </span></a><span class="s3">from </span><span class="s0">traitlets </span><span class="s3">import </span><span class="s4">(</span>
<a name="l15"><span class="ln">15   </span></a>    <span class="s0">Any</span><span class="s4">, </span><span class="s0">HasTraits</span><span class="s4">, </span><span class="s0">Unicode</span><span class="s4">, </span><span class="s0">Dict</span><span class="s4">, </span><span class="s0">Instance</span><span class="s4">, </span><span class="s0">List</span><span class="s4">, </span><span class="s0">Int</span><span class="s4">, </span><span class="s0">Set</span><span class="s4">, </span><span class="s0">Bytes</span><span class="s4">, </span><span class="s0">observe</span><span class="s4">, </span><span class="s0">default</span><span class="s4">, </span><span class="s0">Container</span><span class="s4">,</span>
<a name="l16"><span class="ln">16   </span></a>    <span class="s0">Undefined</span><span class="s4">)</span>
<a name="l17"><span class="ln">17   </span></a><span class="s3">from </span><span class="s0">json </span><span class="s3">import </span><span class="s0">loads </span><span class="s3">as </span><span class="s0">jsonloads</span><span class="s4">, </span><span class="s0">dumps </span><span class="s3">as </span><span class="s0">jsondumps</span>
<a name="l18"><span class="ln">18   </span></a><span class="s3">from </span><span class="s4">.. </span><span class="s3">import </span><span class="s0">comm</span>
<a name="l19"><span class="ln">19   </span></a>
<a name="l20"><span class="ln">20   </span></a><span class="s3">from </span><span class="s0">base64 </span><span class="s3">import </span><span class="s0">standard_b64encode</span>
<a name="l21"><span class="ln">21   </span></a>
<a name="l22"><span class="ln">22   </span></a><span class="s3">from </span><span class="s4">.</span><span class="s0">utils </span><span class="s3">import </span><span class="s0">deprecation</span><span class="s4">, </span><span class="s0">_get_frame</span>
<a name="l23"><span class="ln">23   </span></a>
<a name="l24"><span class="ln">24   </span></a><span class="s3">from </span><span class="s4">..</span><span class="s0">_version </span><span class="s3">import </span><span class="s0">__protocol_version__</span><span class="s4">, </span><span class="s0">__control_protocol_version__</span><span class="s4">, </span><span class="s0">__jupyter_widgets_base_version__</span>
<a name="l25"><span class="ln">25   </span></a>
<a name="l26"><span class="ln">26   </span></a><span class="s3">import </span><span class="s0">inspect</span>
<a name="l27"><span class="ln">27   </span></a><span class="s0">TRAITLETS_FILE </span><span class="s4">= </span><span class="s0">inspect</span><span class="s4">.</span><span class="s0">getfile</span><span class="s4">(</span><span class="s0">HasTraits</span><span class="s4">)</span>
<a name="l28"><span class="ln">28   </span></a>
<a name="l29"><span class="ln">29   </span></a><span class="s1"># Based on jupyter_core.paths.envset</span>
<a name="l30"><span class="ln">30   </span></a><span class="s3">def </span><span class="s0">envset</span><span class="s4">(</span><span class="s0">name</span><span class="s4">, </span><span class="s0">default</span><span class="s4">):</span>
<a name="l31"><span class="ln">31   </span></a>    <span class="s2">&quot;&quot;&quot;Return True if the given environment variable is turned on, otherwise False 
<a name="l32"><span class="ln">32   </span></a>    If the environment variable is set, True will be returned if it is assigned to a value 
<a name="l33"><span class="ln">33   </span></a>    other than 'no', 'n', 'false', 'off', '0', or '0.0' (case insensitive). 
<a name="l34"><span class="ln">34   </span></a>    If the environment variable is not set, the default value is returned. 
<a name="l35"><span class="ln">35   </span></a>    &quot;&quot;&quot;</span>
<a name="l36"><span class="ln">36   </span></a>    <span class="s3">if </span><span class="s0">name </span><span class="s3">in </span><span class="s0">os</span><span class="s4">.</span><span class="s0">environ</span><span class="s4">:</span>
<a name="l37"><span class="ln">37   </span></a>        <span class="s3">return </span><span class="s0">os</span><span class="s4">.</span><span class="s0">environ</span><span class="s4">[</span><span class="s0">name</span><span class="s4">].</span><span class="s0">lower</span><span class="s4">() </span><span class="s3">not in </span><span class="s4">[</span><span class="s5">'no'</span><span class="s4">, </span><span class="s5">'n'</span><span class="s4">, </span><span class="s5">'false'</span><span class="s4">, </span><span class="s5">'off'</span><span class="s4">, </span><span class="s5">'0'</span><span class="s4">, </span><span class="s5">'0.0'</span><span class="s4">]</span>
<a name="l38"><span class="ln">38   </span></a>    <span class="s3">else</span><span class="s4">:</span>
<a name="l39"><span class="ln">39   </span></a>        <span class="s3">return </span><span class="s0">bool</span><span class="s4">(</span><span class="s0">default</span><span class="s4">)</span>
<a name="l40"><span class="ln">40   </span></a>
<a name="l41"><span class="ln">41   </span></a><span class="s0">PROTOCOL_VERSION_MAJOR </span><span class="s4">= </span><span class="s0">__protocol_version__</span><span class="s4">.</span><span class="s0">split</span><span class="s4">(</span><span class="s5">'.'</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">]</span>
<a name="l42"><span class="ln">42   </span></a><span class="s0">CONTROL_PROTOCOL_VERSION_MAJOR </span><span class="s4">= </span><span class="s0">__control_protocol_version__</span><span class="s4">.</span><span class="s0">split</span><span class="s4">(</span><span class="s5">'.'</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">]</span>
<a name="l43"><span class="ln">43   </span></a><span class="s0">JUPYTER_WIDGETS_ECHO </span><span class="s4">= </span><span class="s0">envset</span><span class="s4">(</span><span class="s5">'JUPYTER_WIDGETS_ECHO'</span><span class="s4">, </span><span class="s0">default</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l44"><span class="ln">44   </span></a><span class="s1"># we keep a strong reference for every widget created, for a discussion on using weak references see:</span>
<a name="l45"><span class="ln">45   </span></a><span class="s1">#  https://github.com/jupyter-widgets/ipywidgets/issues/1345</span>
<a name="l46"><span class="ln">46   </span></a><span class="s0">_instances </span><span class="s4">: </span><span class="s0">typing</span><span class="s4">.</span><span class="s0">MutableMapping</span><span class="s4">[</span><span class="s0">str</span><span class="s4">, </span><span class="s5">&quot;Widget&quot;</span><span class="s4">] = {}</span>
<a name="l47"><span class="ln">47   </span></a>
<a name="l48"><span class="ln">48   </span></a><span class="s3">def </span><span class="s0">_widget_to_json</span><span class="s4">(</span><span class="s0">x</span><span class="s4">, </span><span class="s0">obj</span><span class="s4">):</span>
<a name="l49"><span class="ln">49   </span></a>    <span class="s3">if </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">x</span><span class="s4">, </span><span class="s0">dict</span><span class="s4">):</span>
<a name="l50"><span class="ln">50   </span></a>        <span class="s3">return </span><span class="s4">{</span><span class="s0">k</span><span class="s4">: </span><span class="s0">_widget_to_json</span><span class="s4">(</span><span class="s0">v</span><span class="s4">, </span><span class="s0">obj</span><span class="s4">) </span><span class="s3">for </span><span class="s0">k</span><span class="s4">, </span><span class="s0">v </span><span class="s3">in </span><span class="s0">x</span><span class="s4">.</span><span class="s0">items</span><span class="s4">()}</span>
<a name="l51"><span class="ln">51   </span></a>    <span class="s3">elif </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">x</span><span class="s4">, (</span><span class="s0">list</span><span class="s4">, </span><span class="s0">tuple</span><span class="s4">)):</span>
<a name="l52"><span class="ln">52   </span></a>        <span class="s3">return </span><span class="s4">[</span><span class="s0">_widget_to_json</span><span class="s4">(</span><span class="s0">v</span><span class="s4">, </span><span class="s0">obj</span><span class="s4">) </span><span class="s3">for </span><span class="s0">v </span><span class="s3">in </span><span class="s0">x</span><span class="s4">]</span>
<a name="l53"><span class="ln">53   </span></a>    <span class="s3">elif </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">x</span><span class="s4">, </span><span class="s0">Widget</span><span class="s4">):</span>
<a name="l54"><span class="ln">54   </span></a>        <span class="s3">return </span><span class="s5">&quot;IPY_MODEL_&quot; </span><span class="s4">+ </span><span class="s0">x</span><span class="s4">.</span><span class="s0">model_id</span>
<a name="l55"><span class="ln">55   </span></a>    <span class="s3">else</span><span class="s4">:</span>
<a name="l56"><span class="ln">56   </span></a>        <span class="s3">return </span><span class="s0">x</span>
<a name="l57"><span class="ln">57   </span></a>
<a name="l58"><span class="ln">58   </span></a><span class="s3">def </span><span class="s0">_json_to_widget</span><span class="s4">(</span><span class="s0">x</span><span class="s4">, </span><span class="s0">obj</span><span class="s4">):</span>
<a name="l59"><span class="ln">59   </span></a>    <span class="s3">if </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">x</span><span class="s4">, </span><span class="s0">dict</span><span class="s4">):</span>
<a name="l60"><span class="ln">60   </span></a>        <span class="s3">return </span><span class="s4">{</span><span class="s0">k</span><span class="s4">: </span><span class="s0">_json_to_widget</span><span class="s4">(</span><span class="s0">v</span><span class="s4">, </span><span class="s0">obj</span><span class="s4">) </span><span class="s3">for </span><span class="s0">k</span><span class="s4">, </span><span class="s0">v </span><span class="s3">in </span><span class="s0">x</span><span class="s4">.</span><span class="s0">items</span><span class="s4">()}</span>
<a name="l61"><span class="ln">61   </span></a>    <span class="s3">elif </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">x</span><span class="s4">, (</span><span class="s0">list</span><span class="s4">, </span><span class="s0">tuple</span><span class="s4">)):</span>
<a name="l62"><span class="ln">62   </span></a>        <span class="s3">return </span><span class="s4">[</span><span class="s0">_json_to_widget</span><span class="s4">(</span><span class="s0">v</span><span class="s4">, </span><span class="s0">obj</span><span class="s4">) </span><span class="s3">for </span><span class="s0">v </span><span class="s3">in </span><span class="s0">x</span><span class="s4">]</span>
<a name="l63"><span class="ln">63   </span></a>    <span class="s3">elif </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">x</span><span class="s4">, </span><span class="s0">str</span><span class="s4">) </span><span class="s3">and </span><span class="s0">x</span><span class="s4">.</span><span class="s0">startswith</span><span class="s4">(</span><span class="s5">'IPY_MODEL_'</span><span class="s4">) </span><span class="s3">and </span><span class="s0">x</span><span class="s4">[</span><span class="s6">10</span><span class="s4">:] </span><span class="s3">in </span><span class="s0">_instances</span><span class="s4">:</span>
<a name="l64"><span class="ln">64   </span></a>        <span class="s3">return </span><span class="s0">_instances</span><span class="s4">[</span><span class="s0">x</span><span class="s4">[</span><span class="s6">10</span><span class="s4">:]]</span>
<a name="l65"><span class="ln">65   </span></a>    <span class="s3">else</span><span class="s4">:</span>
<a name="l66"><span class="ln">66   </span></a>        <span class="s3">return </span><span class="s0">x</span>
<a name="l67"><span class="ln">67   </span></a>
<a name="l68"><span class="ln">68   </span></a><span class="s0">widget_serialization </span><span class="s4">= {</span>
<a name="l69"><span class="ln">69   </span></a>    <span class="s5">'from_json'</span><span class="s4">: </span><span class="s0">_json_to_widget</span><span class="s4">,</span>
<a name="l70"><span class="ln">70   </span></a>    <span class="s5">'to_json'</span><span class="s4">: </span><span class="s0">_widget_to_json</span>
<a name="l71"><span class="ln">71   </span></a><span class="s4">}</span>
<a name="l72"><span class="ln">72   </span></a>
<a name="l73"><span class="ln">73   </span></a><span class="s0">_binary_types </span><span class="s4">= (</span><span class="s0">memoryview</span><span class="s4">, </span><span class="s0">bytearray</span><span class="s4">, </span><span class="s0">bytes</span><span class="s4">)</span>
<a name="l74"><span class="ln">74   </span></a>
<a name="l75"><span class="ln">75   </span></a><span class="s3">def </span><span class="s0">_put_buffers</span><span class="s4">(</span><span class="s0">state</span><span class="s4">, </span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">):</span>
<a name="l76"><span class="ln">76   </span></a>    <span class="s2">&quot;&quot;&quot;The inverse of _remove_buffers, except here we modify the existing dict/lists. 
<a name="l77"><span class="ln">77   </span></a>    Modifying should be fine, since this is used when state comes from the wire. 
<a name="l78"><span class="ln">78   </span></a>    &quot;&quot;&quot;</span>
<a name="l79"><span class="ln">79   </span></a>    <span class="s3">for </span><span class="s0">buffer_path</span><span class="s4">, </span><span class="s0">buffer </span><span class="s3">in </span><span class="s0">zip</span><span class="s4">(</span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">):</span>
<a name="l80"><span class="ln">80   </span></a>        <span class="s1"># we'd like to set say sync_data['x'][0]['y'] = buffer</span>
<a name="l81"><span class="ln">81   </span></a>        <span class="s1"># where buffer_path in this example would be ['x', 0, 'y']</span>
<a name="l82"><span class="ln">82   </span></a>        <span class="s0">obj </span><span class="s4">= </span><span class="s0">state</span>
<a name="l83"><span class="ln">83   </span></a>        <span class="s3">for </span><span class="s0">key </span><span class="s3">in </span><span class="s0">buffer_path</span><span class="s4">[:-</span><span class="s6">1</span><span class="s4">]:</span>
<a name="l84"><span class="ln">84   </span></a>            <span class="s0">obj </span><span class="s4">= </span><span class="s0">obj</span><span class="s4">[</span><span class="s0">key</span><span class="s4">]</span>
<a name="l85"><span class="ln">85   </span></a>        <span class="s0">obj</span><span class="s4">[</span><span class="s0">buffer_path</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]] = </span><span class="s0">buffer</span>
<a name="l86"><span class="ln">86   </span></a>
<a name="l87"><span class="ln">87   </span></a><span class="s3">def </span><span class="s0">_separate_buffers</span><span class="s4">(</span><span class="s0">substate</span><span class="s4">, </span><span class="s0">path</span><span class="s4">, </span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">):</span>
<a name="l88"><span class="ln">88   </span></a>    <span class="s2">&quot;&quot;&quot;For internal, see _remove_buffers&quot;&quot;&quot;</span>
<a name="l89"><span class="ln">89   </span></a>    <span class="s1"># remove binary types from dicts and lists, but keep track of their paths</span>
<a name="l90"><span class="ln">90   </span></a>    <span class="s1"># any part of the dict/list that needs modification will be cloned, so the original stays untouched</span>
<a name="l91"><span class="ln">91   </span></a>    <span class="s1"># e.g. {'x': {'ar': ar}, 'y': [ar2, ar3]}, where ar/ar2/ar3 are binary types</span>
<a name="l92"><span class="ln">92   </span></a>    <span class="s1"># will result in {'x': {}, 'y': [None, None]}, [ar, ar2, ar3], [['x', 'ar'], ['y', 0], ['y', 1]]</span>
<a name="l93"><span class="ln">93   </span></a>    <span class="s1"># instead of removing elements from the list, this will make replacing the buffers on the js side much easier</span>
<a name="l94"><span class="ln">94   </span></a>    <span class="s3">if </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">substate</span><span class="s4">, (</span><span class="s0">list</span><span class="s4">, </span><span class="s0">tuple</span><span class="s4">)):</span>
<a name="l95"><span class="ln">95   </span></a>        <span class="s0">is_cloned </span><span class="s4">= </span><span class="s3">False</span>
<a name="l96"><span class="ln">96   </span></a>        <span class="s3">for </span><span class="s0">i</span><span class="s4">, </span><span class="s0">v </span><span class="s3">in </span><span class="s0">enumerate</span><span class="s4">(</span><span class="s0">substate</span><span class="s4">):</span>
<a name="l97"><span class="ln">97   </span></a>            <span class="s3">if </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">v</span><span class="s4">, </span><span class="s0">_binary_types</span><span class="s4">):</span>
<a name="l98"><span class="ln">98   </span></a>                <span class="s3">if not </span><span class="s0">is_cloned</span><span class="s4">:</span>
<a name="l99"><span class="ln">99   </span></a>                    <span class="s0">substate </span><span class="s4">= </span><span class="s0">list</span><span class="s4">(</span><span class="s0">substate</span><span class="s4">) </span><span class="s1"># shallow clone list/tuple</span>
<a name="l100"><span class="ln">100  </span></a>                    <span class="s0">is_cloned </span><span class="s4">= </span><span class="s3">True</span>
<a name="l101"><span class="ln">101  </span></a>                <span class="s0">substate</span><span class="s4">[</span><span class="s0">i</span><span class="s4">] = </span><span class="s3">None</span>
<a name="l102"><span class="ln">102  </span></a>                <span class="s0">buffers</span><span class="s4">.</span><span class="s0">append</span><span class="s4">(</span><span class="s0">v</span><span class="s4">)</span>
<a name="l103"><span class="ln">103  </span></a>                <span class="s0">buffer_paths</span><span class="s4">.</span><span class="s0">append</span><span class="s4">(</span><span class="s0">path </span><span class="s4">+ [</span><span class="s0">i</span><span class="s4">])</span>
<a name="l104"><span class="ln">104  </span></a>            <span class="s3">elif </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">v</span><span class="s4">, (</span><span class="s0">dict</span><span class="s4">, </span><span class="s0">list</span><span class="s4">, </span><span class="s0">tuple</span><span class="s4">)):</span>
<a name="l105"><span class="ln">105  </span></a>                <span class="s0">vnew </span><span class="s4">= </span><span class="s0">_separate_buffers</span><span class="s4">(</span><span class="s0">v</span><span class="s4">, </span><span class="s0">path </span><span class="s4">+ [</span><span class="s0">i</span><span class="s4">], </span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">)</span>
<a name="l106"><span class="ln">106  </span></a>                <span class="s3">if </span><span class="s0">v </span><span class="s3">is not </span><span class="s0">vnew</span><span class="s4">: </span><span class="s1"># only assign when value changed</span>
<a name="l107"><span class="ln">107  </span></a>                    <span class="s3">if not </span><span class="s0">is_cloned</span><span class="s4">:</span>
<a name="l108"><span class="ln">108  </span></a>                        <span class="s0">substate </span><span class="s4">= </span><span class="s0">list</span><span class="s4">(</span><span class="s0">substate</span><span class="s4">) </span><span class="s1"># clone list/tuple</span>
<a name="l109"><span class="ln">109  </span></a>                        <span class="s0">is_cloned </span><span class="s4">= </span><span class="s3">True</span>
<a name="l110"><span class="ln">110  </span></a>                    <span class="s0">substate</span><span class="s4">[</span><span class="s0">i</span><span class="s4">] = </span><span class="s0">vnew</span>
<a name="l111"><span class="ln">111  </span></a>    <span class="s3">elif </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">substate</span><span class="s4">, </span><span class="s0">dict</span><span class="s4">):</span>
<a name="l112"><span class="ln">112  </span></a>        <span class="s0">is_cloned </span><span class="s4">= </span><span class="s3">False</span>
<a name="l113"><span class="ln">113  </span></a>        <span class="s3">for </span><span class="s0">k</span><span class="s4">, </span><span class="s0">v </span><span class="s3">in </span><span class="s0">substate</span><span class="s4">.</span><span class="s0">items</span><span class="s4">():</span>
<a name="l114"><span class="ln">114  </span></a>            <span class="s3">if </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">v</span><span class="s4">, </span><span class="s0">_binary_types</span><span class="s4">):</span>
<a name="l115"><span class="ln">115  </span></a>                <span class="s3">if not </span><span class="s0">is_cloned</span><span class="s4">:</span>
<a name="l116"><span class="ln">116  </span></a>                    <span class="s0">substate </span><span class="s4">= </span><span class="s0">dict</span><span class="s4">(</span><span class="s0">substate</span><span class="s4">) </span><span class="s1"># shallow clone dict</span>
<a name="l117"><span class="ln">117  </span></a>                    <span class="s0">is_cloned </span><span class="s4">= </span><span class="s3">True</span>
<a name="l118"><span class="ln">118  </span></a>                <span class="s3">del </span><span class="s0">substate</span><span class="s4">[</span><span class="s0">k</span><span class="s4">]</span>
<a name="l119"><span class="ln">119  </span></a>                <span class="s0">buffers</span><span class="s4">.</span><span class="s0">append</span><span class="s4">(</span><span class="s0">v</span><span class="s4">)</span>
<a name="l120"><span class="ln">120  </span></a>                <span class="s0">buffer_paths</span><span class="s4">.</span><span class="s0">append</span><span class="s4">(</span><span class="s0">path </span><span class="s4">+ [</span><span class="s0">k</span><span class="s4">])</span>
<a name="l121"><span class="ln">121  </span></a>            <span class="s3">elif </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">v</span><span class="s4">, (</span><span class="s0">dict</span><span class="s4">, </span><span class="s0">list</span><span class="s4">, </span><span class="s0">tuple</span><span class="s4">)):</span>
<a name="l122"><span class="ln">122  </span></a>                <span class="s0">vnew </span><span class="s4">= </span><span class="s0">_separate_buffers</span><span class="s4">(</span><span class="s0">v</span><span class="s4">, </span><span class="s0">path </span><span class="s4">+ [</span><span class="s0">k</span><span class="s4">], </span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">)</span>
<a name="l123"><span class="ln">123  </span></a>                <span class="s3">if </span><span class="s0">v </span><span class="s3">is not </span><span class="s0">vnew</span><span class="s4">: </span><span class="s1"># only assign when value changed</span>
<a name="l124"><span class="ln">124  </span></a>                    <span class="s3">if not </span><span class="s0">is_cloned</span><span class="s4">:</span>
<a name="l125"><span class="ln">125  </span></a>                        <span class="s0">substate </span><span class="s4">= </span><span class="s0">dict</span><span class="s4">(</span><span class="s0">substate</span><span class="s4">) </span><span class="s1"># clone list/tuple</span>
<a name="l126"><span class="ln">126  </span></a>                        <span class="s0">is_cloned </span><span class="s4">= </span><span class="s3">True</span>
<a name="l127"><span class="ln">127  </span></a>                    <span class="s0">substate</span><span class="s4">[</span><span class="s0">k</span><span class="s4">] = </span><span class="s0">vnew</span>
<a name="l128"><span class="ln">128  </span></a>    <span class="s3">else</span><span class="s4">:</span>
<a name="l129"><span class="ln">129  </span></a>        <span class="s3">raise </span><span class="s0">ValueError</span><span class="s4">(</span><span class="s5">&quot;expected state to be a list or dict, not %r&quot; </span><span class="s4">% </span><span class="s0">substate</span><span class="s4">)</span>
<a name="l130"><span class="ln">130  </span></a>    <span class="s3">return </span><span class="s0">substate</span>
<a name="l131"><span class="ln">131  </span></a>
<a name="l132"><span class="ln">132  </span></a><span class="s3">def </span><span class="s0">_remove_buffers</span><span class="s4">(</span><span class="s0">state</span><span class="s4">):</span>
<a name="l133"><span class="ln">133  </span></a>    <span class="s2">&quot;&quot;&quot;Return (state_without_buffers, buffer_paths, buffers) for binary message parts 
<a name="l134"><span class="ln">134  </span></a> 
<a name="l135"><span class="ln">135  </span></a>    A binary message part is a memoryview, bytearray, or python 3 bytes object. 
<a name="l136"><span class="ln">136  </span></a> 
<a name="l137"><span class="ln">137  </span></a>    As an example: 
<a name="l138"><span class="ln">138  </span></a>    &gt;&gt;&gt; state = {'plain': [0, 'text'], 'x': {'ar': memoryview(ar1)}, 'y': {'shape': (10,10), 'data': memoryview(ar2)}} 
<a name="l139"><span class="ln">139  </span></a>    &gt;&gt;&gt; _remove_buffers(state) 
<a name="l140"><span class="ln">140  </span></a>    ({'plain': [0, 'text']}, {'x': {}, 'y': {'shape': (10, 10)}}, [['x', 'ar'], ['y', 'data']], 
<a name="l141"><span class="ln">141  </span></a>     [&lt;memory at 0x107ffec48&gt;, &lt;memory at 0x107ffed08&gt;]) 
<a name="l142"><span class="ln">142  </span></a>    &quot;&quot;&quot;</span>
<a name="l143"><span class="ln">143  </span></a>    <span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers </span><span class="s4">= [], []</span>
<a name="l144"><span class="ln">144  </span></a>    <span class="s0">state </span><span class="s4">= </span><span class="s0">_separate_buffers</span><span class="s4">(</span><span class="s0">state</span><span class="s4">, [], </span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">)</span>
<a name="l145"><span class="ln">145  </span></a>    <span class="s3">return </span><span class="s0">state</span><span class="s4">, </span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers</span>
<a name="l146"><span class="ln">146  </span></a>
<a name="l147"><span class="ln">147  </span></a><span class="s3">def </span><span class="s0">_buffer_list_equal</span><span class="s4">(</span><span class="s0">a</span><span class="s4">, </span><span class="s0">b</span><span class="s4">):</span>
<a name="l148"><span class="ln">148  </span></a>    <span class="s2">&quot;&quot;&quot;Compare two lists of buffers for equality. 
<a name="l149"><span class="ln">149  </span></a> 
<a name="l150"><span class="ln">150  </span></a>    Used to decide whether two sequences of buffers (memoryviews, 
<a name="l151"><span class="ln">151  </span></a>    bytearrays, or python 3 bytes) differ, such that a sync is needed. 
<a name="l152"><span class="ln">152  </span></a> 
<a name="l153"><span class="ln">153  </span></a>    Returns True if equal, False if unequal 
<a name="l154"><span class="ln">154  </span></a>    &quot;&quot;&quot;</span>
<a name="l155"><span class="ln">155  </span></a>    <span class="s3">if </span><span class="s0">len</span><span class="s4">(</span><span class="s0">a</span><span class="s4">) != </span><span class="s0">len</span><span class="s4">(</span><span class="s0">b</span><span class="s4">):</span>
<a name="l156"><span class="ln">156  </span></a>        <span class="s3">return False</span>
<a name="l157"><span class="ln">157  </span></a>    <span class="s3">if </span><span class="s0">a </span><span class="s4">== </span><span class="s0">b</span><span class="s4">:</span>
<a name="l158"><span class="ln">158  </span></a>        <span class="s3">return True</span>
<a name="l159"><span class="ln">159  </span></a>    <span class="s3">for </span><span class="s0">ia</span><span class="s4">, </span><span class="s0">ib </span><span class="s3">in </span><span class="s0">zip</span><span class="s4">(</span><span class="s0">a</span><span class="s4">, </span><span class="s0">b</span><span class="s4">):</span>
<a name="l160"><span class="ln">160  </span></a>        <span class="s1"># Check byte equality, since bytes are what is actually synced</span>
<a name="l161"><span class="ln">161  </span></a>        <span class="s1"># NOTE: Simple ia != ib does not always work as intended, as</span>
<a name="l162"><span class="ln">162  </span></a>        <span class="s1"># e.g. memoryview(np.frombuffer(ia, dtype='float32')) !=</span>
<a name="l163"><span class="ln">163  </span></a>        <span class="s1"># memoryview(np.frombuffer(b)), since the format info differs.</span>
<a name="l164"><span class="ln">164  </span></a>        <span class="s1"># Compare without copying.</span>
<a name="l165"><span class="ln">165  </span></a>        <span class="s3">if </span><span class="s0">memoryview</span><span class="s4">(</span><span class="s0">ia</span><span class="s4">).</span><span class="s0">cast</span><span class="s4">(</span><span class="s5">'B'</span><span class="s4">) != </span><span class="s0">memoryview</span><span class="s4">(</span><span class="s0">ib</span><span class="s4">).</span><span class="s0">cast</span><span class="s4">(</span><span class="s5">'B'</span><span class="s4">):</span>
<a name="l166"><span class="ln">166  </span></a>            <span class="s3">return False</span>
<a name="l167"><span class="ln">167  </span></a>    <span class="s3">return True</span>
<a name="l168"><span class="ln">168  </span></a>
<a name="l169"><span class="ln">169  </span></a>
<a name="l170"><span class="ln">170  </span></a><span class="s3">class </span><span class="s0">LoggingHasTraits</span><span class="s4">(</span><span class="s0">HasTraits</span><span class="s4">):</span>
<a name="l171"><span class="ln">171  </span></a>    <span class="s2">&quot;&quot;&quot;A parent class for HasTraits that log. 
<a name="l172"><span class="ln">172  </span></a>    Subclasses have a log trait, and the default behavior 
<a name="l173"><span class="ln">173  </span></a>    is to get the logger from the currently running Application. 
<a name="l174"><span class="ln">174  </span></a>    &quot;&quot;&quot;</span>
<a name="l175"><span class="ln">175  </span></a>    <span class="s0">log </span><span class="s4">= </span><span class="s0">Instance</span><span class="s4">(</span><span class="s5">'logging.Logger'</span><span class="s4">)</span>
<a name="l176"><span class="ln">176  </span></a>    <span class="s4">@</span><span class="s0">default</span><span class="s4">(</span><span class="s5">'log'</span><span class="s4">)</span>
<a name="l177"><span class="ln">177  </span></a>    <span class="s3">def </span><span class="s0">_log_default</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l178"><span class="ln">178  </span></a>        <span class="s3">from </span><span class="s0">traitlets </span><span class="s3">import </span><span class="s0">log</span>
<a name="l179"><span class="ln">179  </span></a>        <span class="s3">return </span><span class="s0">log</span><span class="s4">.</span><span class="s0">get_logger</span><span class="s4">()</span>
<a name="l180"><span class="ln">180  </span></a>
<a name="l181"><span class="ln">181  </span></a>
<a name="l182"><span class="ln">182  </span></a><span class="s3">class </span><span class="s0">CallbackDispatcher</span><span class="s4">(</span><span class="s0">LoggingHasTraits</span><span class="s4">):</span>
<a name="l183"><span class="ln">183  </span></a>    <span class="s2">&quot;&quot;&quot;A structure for registering and running callbacks&quot;&quot;&quot;</span>
<a name="l184"><span class="ln">184  </span></a>    <span class="s0">callbacks </span><span class="s4">= </span><span class="s0">List</span><span class="s4">()</span>
<a name="l185"><span class="ln">185  </span></a>
<a name="l186"><span class="ln">186  </span></a>    <span class="s3">def </span><span class="s0">__call__</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, *</span><span class="s0">args</span><span class="s4">, **</span><span class="s0">kwargs</span><span class="s4">):</span>
<a name="l187"><span class="ln">187  </span></a>        <span class="s2">&quot;&quot;&quot;Call all of the registered callbacks.&quot;&quot;&quot;</span>
<a name="l188"><span class="ln">188  </span></a>        <span class="s0">value </span><span class="s4">= </span><span class="s3">None</span>
<a name="l189"><span class="ln">189  </span></a>        <span class="s3">for </span><span class="s0">callback </span><span class="s3">in </span><span class="s0">self</span><span class="s4">.</span><span class="s0">callbacks</span><span class="s4">:</span>
<a name="l190"><span class="ln">190  </span></a>            <span class="s3">try</span><span class="s4">:</span>
<a name="l191"><span class="ln">191  </span></a>                <span class="s0">local_value </span><span class="s4">= </span><span class="s0">callback</span><span class="s4">(*</span><span class="s0">args</span><span class="s4">, **</span><span class="s0">kwargs</span><span class="s4">)</span>
<a name="l192"><span class="ln">192  </span></a>            <span class="s3">except </span><span class="s0">Exception </span><span class="s3">as </span><span class="s0">e</span><span class="s4">:</span>
<a name="l193"><span class="ln">193  </span></a>                <span class="s0">ip </span><span class="s4">= </span><span class="s0">get_ipython</span><span class="s4">()</span>
<a name="l194"><span class="ln">194  </span></a>                <span class="s3">if </span><span class="s0">ip </span><span class="s3">is None</span><span class="s4">:</span>
<a name="l195"><span class="ln">195  </span></a>                    <span class="s0">self</span><span class="s4">.</span><span class="s0">log</span><span class="s4">.</span><span class="s0">warning</span><span class="s4">(</span><span class="s5">&quot;Exception in callback %s: %s&quot;</span><span class="s4">, </span><span class="s0">callback</span><span class="s4">, </span><span class="s0">e</span><span class="s4">, </span><span class="s0">exc_info</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l196"><span class="ln">196  </span></a>                <span class="s3">else</span><span class="s4">:</span>
<a name="l197"><span class="ln">197  </span></a>                    <span class="s0">ip</span><span class="s4">.</span><span class="s0">showtraceback</span><span class="s4">()</span>
<a name="l198"><span class="ln">198  </span></a>            <span class="s3">else</span><span class="s4">:</span>
<a name="l199"><span class="ln">199  </span></a>                <span class="s0">value </span><span class="s4">= </span><span class="s0">local_value </span><span class="s3">if </span><span class="s0">local_value </span><span class="s3">is not None else </span><span class="s0">value</span>
<a name="l200"><span class="ln">200  </span></a>        <span class="s3">return </span><span class="s0">value</span>
<a name="l201"><span class="ln">201  </span></a>
<a name="l202"><span class="ln">202  </span></a>    <span class="s3">def </span><span class="s0">register_callback</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">callback</span><span class="s4">, </span><span class="s0">remove</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
<a name="l203"><span class="ln">203  </span></a>        <span class="s2">&quot;&quot;&quot;(Un)Register a callback 
<a name="l204"><span class="ln">204  </span></a> 
<a name="l205"><span class="ln">205  </span></a>        Parameters 
<a name="l206"><span class="ln">206  </span></a>        ---------- 
<a name="l207"><span class="ln">207  </span></a>        callback: method handle 
<a name="l208"><span class="ln">208  </span></a>            Method to be registered or unregistered. 
<a name="l209"><span class="ln">209  </span></a>        remove=False: bool 
<a name="l210"><span class="ln">210  </span></a>            Whether to unregister the callback.&quot;&quot;&quot;</span>
<a name="l211"><span class="ln">211  </span></a>
<a name="l212"><span class="ln">212  </span></a>        <span class="s1"># (Un)Register the callback.</span>
<a name="l213"><span class="ln">213  </span></a>        <span class="s3">if </span><span class="s0">remove </span><span class="s3">and </span><span class="s0">callback </span><span class="s3">in </span><span class="s0">self</span><span class="s4">.</span><span class="s0">callbacks</span><span class="s4">:</span>
<a name="l214"><span class="ln">214  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">callbacks</span><span class="s4">.</span><span class="s0">remove</span><span class="s4">(</span><span class="s0">callback</span><span class="s4">)</span>
<a name="l215"><span class="ln">215  </span></a>        <span class="s3">elif not </span><span class="s0">remove </span><span class="s3">and </span><span class="s0">callback </span><span class="s3">not in </span><span class="s0">self</span><span class="s4">.</span><span class="s0">callbacks</span><span class="s4">:</span>
<a name="l216"><span class="ln">216  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">callbacks</span><span class="s4">.</span><span class="s0">append</span><span class="s4">(</span><span class="s0">callback</span><span class="s4">)</span>
<a name="l217"><span class="ln">217  </span></a>
<a name="l218"><span class="ln">218  </span></a><span class="s3">def </span><span class="s0">_show_traceback</span><span class="s4">(</span><span class="s0">method</span><span class="s4">):</span>
<a name="l219"><span class="ln">219  </span></a>    <span class="s2">&quot;&quot;&quot;decorator for showing tracebacks&quot;&quot;&quot;</span>
<a name="l220"><span class="ln">220  </span></a>    <span class="s3">def </span><span class="s0">m</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, *</span><span class="s0">args</span><span class="s4">, **</span><span class="s0">kwargs</span><span class="s4">):</span>
<a name="l221"><span class="ln">221  </span></a>        <span class="s3">try</span><span class="s4">:</span>
<a name="l222"><span class="ln">222  </span></a>            <span class="s3">return</span><span class="s4">(</span><span class="s0">method</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, *</span><span class="s0">args</span><span class="s4">, **</span><span class="s0">kwargs</span><span class="s4">))</span>
<a name="l223"><span class="ln">223  </span></a>        <span class="s3">except </span><span class="s0">Exception </span><span class="s3">as </span><span class="s0">e</span><span class="s4">:</span>
<a name="l224"><span class="ln">224  </span></a>            <span class="s0">ip </span><span class="s4">= </span><span class="s0">get_ipython</span><span class="s4">()</span>
<a name="l225"><span class="ln">225  </span></a>            <span class="s3">if </span><span class="s0">ip </span><span class="s3">is None</span><span class="s4">:</span>
<a name="l226"><span class="ln">226  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">log</span><span class="s4">.</span><span class="s0">warning</span><span class="s4">(</span><span class="s5">&quot;Exception in widget method %s: %s&quot;</span><span class="s4">, </span><span class="s0">method</span><span class="s4">, </span><span class="s0">e</span><span class="s4">, </span><span class="s0">exc_info</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l227"><span class="ln">227  </span></a>            <span class="s3">else</span><span class="s4">:</span>
<a name="l228"><span class="ln">228  </span></a>                <span class="s0">ip</span><span class="s4">.</span><span class="s0">showtraceback</span><span class="s4">()</span>
<a name="l229"><span class="ln">229  </span></a>    <span class="s3">return </span><span class="s0">m</span>
<a name="l230"><span class="ln">230  </span></a>
<a name="l231"><span class="ln">231  </span></a>
<a name="l232"><span class="ln">232  </span></a><span class="s3">class </span><span class="s0">WidgetRegistry</span><span class="s4">:</span>
<a name="l233"><span class="ln">233  </span></a>
<a name="l234"><span class="ln">234  </span></a>    <span class="s3">def </span><span class="s0">__init__</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l235"><span class="ln">235  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">_registry </span><span class="s4">= {}</span>
<a name="l236"><span class="ln">236  </span></a>
<a name="l237"><span class="ln">237  </span></a>    <span class="s3">def </span><span class="s0">register</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">model_module</span><span class="s4">, </span><span class="s0">model_module_version_range</span><span class="s4">, </span><span class="s0">model_name</span><span class="s4">, </span><span class="s0">view_module</span><span class="s4">, </span><span class="s0">view_module_version_range</span><span class="s4">, </span><span class="s0">view_name</span><span class="s4">, </span><span class="s0">klass</span><span class="s4">):</span>
<a name="l238"><span class="ln">238  </span></a>        <span class="s2">&quot;&quot;&quot;Register a value&quot;&quot;&quot;</span>
<a name="l239"><span class="ln">239  </span></a>        <span class="s0">model_module </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_registry</span><span class="s4">.</span><span class="s0">setdefault</span><span class="s4">(</span><span class="s0">model_module</span><span class="s4">, {})</span>
<a name="l240"><span class="ln">240  </span></a>        <span class="s0">model_version </span><span class="s4">= </span><span class="s0">model_module</span><span class="s4">.</span><span class="s0">setdefault</span><span class="s4">(</span><span class="s0">model_module_version_range</span><span class="s4">, {})</span>
<a name="l241"><span class="ln">241  </span></a>        <span class="s0">model_name </span><span class="s4">= </span><span class="s0">model_version</span><span class="s4">.</span><span class="s0">setdefault</span><span class="s4">(</span><span class="s0">model_name</span><span class="s4">, {})</span>
<a name="l242"><span class="ln">242  </span></a>        <span class="s0">view_module </span><span class="s4">= </span><span class="s0">model_name</span><span class="s4">.</span><span class="s0">setdefault</span><span class="s4">(</span><span class="s0">view_module</span><span class="s4">, {})</span>
<a name="l243"><span class="ln">243  </span></a>        <span class="s0">view_version </span><span class="s4">= </span><span class="s0">view_module</span><span class="s4">.</span><span class="s0">setdefault</span><span class="s4">(</span><span class="s0">view_module_version_range</span><span class="s4">, {})</span>
<a name="l244"><span class="ln">244  </span></a>        <span class="s0">view_version</span><span class="s4">[</span><span class="s0">view_name</span><span class="s4">] = </span><span class="s0">klass</span>
<a name="l245"><span class="ln">245  </span></a>
<a name="l246"><span class="ln">246  </span></a>    <span class="s3">def </span><span class="s0">get</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">model_module</span><span class="s4">, </span><span class="s0">model_module_version</span><span class="s4">, </span><span class="s0">model_name</span><span class="s4">, </span><span class="s0">view_module</span><span class="s4">, </span><span class="s0">view_module_version</span><span class="s4">, </span><span class="s0">view_name</span><span class="s4">):</span>
<a name="l247"><span class="ln">247  </span></a>        <span class="s2">&quot;&quot;&quot;Get a value&quot;&quot;&quot;</span>
<a name="l248"><span class="ln">248  </span></a>        <span class="s0">module_versions </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_registry</span><span class="s4">[</span><span class="s0">model_module</span><span class="s4">]</span>
<a name="l249"><span class="ln">249  </span></a>        <span class="s1"># The python semver module doesn't work well, for example, it can't do match('3', '*')</span>
<a name="l250"><span class="ln">250  </span></a>        <span class="s1"># so we just take the first model module version.</span>
<a name="l251"><span class="ln">251  </span></a>        <span class="s1">#model_names = next(v for k, v in module_versions.items()</span>
<a name="l252"><span class="ln">252  </span></a>        <span class="s1">#                   if semver.match(model_module_version, k))</span>
<a name="l253"><span class="ln">253  </span></a>        <span class="s0">model_names </span><span class="s4">= </span><span class="s0">list</span><span class="s4">(</span><span class="s0">module_versions</span><span class="s4">.</span><span class="s0">values</span><span class="s4">())[</span><span class="s6">0</span><span class="s4">]</span>
<a name="l254"><span class="ln">254  </span></a>        <span class="s0">view_modules </span><span class="s4">= </span><span class="s0">model_names</span><span class="s4">[</span><span class="s0">model_name</span><span class="s4">]</span>
<a name="l255"><span class="ln">255  </span></a>        <span class="s0">view_versions </span><span class="s4">= </span><span class="s0">view_modules</span><span class="s4">[</span><span class="s0">view_module</span><span class="s4">]</span>
<a name="l256"><span class="ln">256  </span></a>        <span class="s1"># The python semver module doesn't work well, so we just take the first view module version</span>
<a name="l257"><span class="ln">257  </span></a>        <span class="s1">#view_names = next(v for k, v in view_versions.items()</span>
<a name="l258"><span class="ln">258  </span></a>        <span class="s1">#                  if semver.match(view_module_version, k))</span>
<a name="l259"><span class="ln">259  </span></a>        <span class="s0">view_names </span><span class="s4">= </span><span class="s0">list</span><span class="s4">(</span><span class="s0">view_versions</span><span class="s4">.</span><span class="s0">values</span><span class="s4">())[</span><span class="s6">0</span><span class="s4">]</span>
<a name="l260"><span class="ln">260  </span></a>        <span class="s0">widget_class </span><span class="s4">= </span><span class="s0">view_names</span><span class="s4">[</span><span class="s0">view_name</span><span class="s4">]</span>
<a name="l261"><span class="ln">261  </span></a>        <span class="s3">return </span><span class="s0">widget_class</span>
<a name="l262"><span class="ln">262  </span></a>
<a name="l263"><span class="ln">263  </span></a>    <span class="s3">def </span><span class="s0">items</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l264"><span class="ln">264  </span></a>        <span class="s3">for </span><span class="s0">model_module</span><span class="s4">, </span><span class="s0">mm </span><span class="s3">in </span><span class="s0">sorted</span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">_registry</span><span class="s4">.</span><span class="s0">items</span><span class="s4">()):</span>
<a name="l265"><span class="ln">265  </span></a>            <span class="s3">for </span><span class="s0">model_version</span><span class="s4">, </span><span class="s0">mv </span><span class="s3">in </span><span class="s0">sorted</span><span class="s4">(</span><span class="s0">mm</span><span class="s4">.</span><span class="s0">items</span><span class="s4">()):</span>
<a name="l266"><span class="ln">266  </span></a>                <span class="s3">for </span><span class="s0">model_name</span><span class="s4">, </span><span class="s0">vm </span><span class="s3">in </span><span class="s0">sorted</span><span class="s4">(</span><span class="s0">mv</span><span class="s4">.</span><span class="s0">items</span><span class="s4">()):</span>
<a name="l267"><span class="ln">267  </span></a>                    <span class="s3">for </span><span class="s0">view_module</span><span class="s4">, </span><span class="s0">vv </span><span class="s3">in </span><span class="s0">sorted</span><span class="s4">(</span><span class="s0">vm</span><span class="s4">.</span><span class="s0">items</span><span class="s4">()):</span>
<a name="l268"><span class="ln">268  </span></a>                        <span class="s3">for </span><span class="s0">view_version</span><span class="s4">, </span><span class="s0">vn </span><span class="s3">in </span><span class="s0">sorted</span><span class="s4">(</span><span class="s0">vv</span><span class="s4">.</span><span class="s0">items</span><span class="s4">()):</span>
<a name="l269"><span class="ln">269  </span></a>                            <span class="s3">for </span><span class="s0">view_name</span><span class="s4">, </span><span class="s0">widget </span><span class="s3">in </span><span class="s0">sorted</span><span class="s4">(</span><span class="s0">vn</span><span class="s4">.</span><span class="s0">items</span><span class="s4">()):</span>
<a name="l270"><span class="ln">270  </span></a>                                    <span class="s3">yield </span><span class="s4">(</span><span class="s0">model_module</span><span class="s4">, </span><span class="s0">model_version</span><span class="s4">, </span><span class="s0">model_name</span><span class="s4">, </span><span class="s0">view_module</span><span class="s4">, </span><span class="s0">view_version</span><span class="s4">, </span><span class="s0">view_name</span><span class="s4">), </span><span class="s0">widget</span>
<a name="l271"><span class="ln">271  </span></a>
<a name="l272"><span class="ln">272  </span></a>
<a name="l273"><span class="ln">273  </span></a>
<a name="l274"><span class="ln">274  </span></a><span class="s1"># a registry of widgets by module, version, and name so we can create a Python model from widgets</span>
<a name="l275"><span class="ln">275  </span></a><span class="s1"># that are constructed from the frontend.</span>
<a name="l276"><span class="ln">276  </span></a><span class="s0">_registry </span><span class="s4">= </span><span class="s0">WidgetRegistry</span><span class="s4">()</span>
<a name="l277"><span class="ln">277  </span></a>
<a name="l278"><span class="ln">278  </span></a><span class="s3">def </span><span class="s0">register</span><span class="s4">(</span><span class="s0">widget</span><span class="s4">):</span>
<a name="l279"><span class="ln">279  </span></a>    <span class="s2">&quot;&quot;&quot;A decorator registering a widget class in the widget registry.&quot;&quot;&quot;</span>
<a name="l280"><span class="ln">280  </span></a>    <span class="s0">w </span><span class="s4">= </span><span class="s0">widget</span><span class="s4">.</span><span class="s0">class_traits</span><span class="s4">()</span>
<a name="l281"><span class="ln">281  </span></a>    <span class="s0">_registry</span><span class="s4">.</span><span class="s0">register</span><span class="s4">(</span><span class="s0">w</span><span class="s4">[</span><span class="s5">'_model_module'</span><span class="s4">].</span><span class="s0">default_value</span><span class="s4">,</span>
<a name="l282"><span class="ln">282  </span></a>                                 <span class="s0">w</span><span class="s4">[</span><span class="s5">'_model_module_version'</span><span class="s4">].</span><span class="s0">default_value</span><span class="s4">,</span>
<a name="l283"><span class="ln">283  </span></a>                                 <span class="s0">w</span><span class="s4">[</span><span class="s5">'_model_name'</span><span class="s4">].</span><span class="s0">default_value</span><span class="s4">,</span>
<a name="l284"><span class="ln">284  </span></a>                                 <span class="s0">w</span><span class="s4">[</span><span class="s5">'_view_module'</span><span class="s4">].</span><span class="s0">default_value</span><span class="s4">,</span>
<a name="l285"><span class="ln">285  </span></a>                                 <span class="s0">w</span><span class="s4">[</span><span class="s5">'_view_module_version'</span><span class="s4">].</span><span class="s0">default_value</span><span class="s4">,</span>
<a name="l286"><span class="ln">286  </span></a>                                 <span class="s0">w</span><span class="s4">[</span><span class="s5">'_view_name'</span><span class="s4">].</span><span class="s0">default_value</span><span class="s4">,</span>
<a name="l287"><span class="ln">287  </span></a>                                 <span class="s0">widget</span><span class="s4">)</span>
<a name="l288"><span class="ln">288  </span></a>    <span class="s3">return </span><span class="s0">widget</span>
<a name="l289"><span class="ln">289  </span></a>
<a name="l290"><span class="ln">290  </span></a>
<a name="l291"><span class="ln">291  </span></a><span class="s3">class </span><span class="s0">_staticproperty</span><span class="s4">(</span><span class="s0">object</span><span class="s4">):</span>
<a name="l292"><span class="ln">292  </span></a>    <span class="s3">def </span><span class="s0">__init__</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">fget</span><span class="s4">):</span>
<a name="l293"><span class="ln">293  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">fget </span><span class="s4">= </span><span class="s0">fget</span>
<a name="l294"><span class="ln">294  </span></a>
<a name="l295"><span class="ln">295  </span></a>    <span class="s3">def </span><span class="s0">__get__</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">owner_self</span><span class="s4">, </span><span class="s0">owner_cls</span><span class="s4">):</span>
<a name="l296"><span class="ln">296  </span></a>        <span class="s3">assert </span><span class="s0">owner_self </span><span class="s3">is None</span>
<a name="l297"><span class="ln">297  </span></a>        <span class="s3">return </span><span class="s0">self</span><span class="s4">.</span><span class="s0">fget</span><span class="s4">()</span>
<a name="l298"><span class="ln">298  </span></a>
<a name="l299"><span class="ln">299  </span></a>
<a name="l300"><span class="ln">300  </span></a>
<a name="l301"><span class="ln">301  </span></a><span class="s3">class </span><span class="s0">Widget</span><span class="s4">(</span><span class="s0">LoggingHasTraits</span><span class="s4">):</span>
<a name="l302"><span class="ln">302  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l303"><span class="ln">303  </span></a>    <span class="s1"># Class attributes</span>
<a name="l304"><span class="ln">304  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l305"><span class="ln">305  </span></a>    <span class="s0">_widget_construction_callback </span><span class="s4">= </span><span class="s3">None</span>
<a name="l306"><span class="ln">306  </span></a>    <span class="s0">_control_comm </span><span class="s4">= </span><span class="s3">None</span>
<a name="l307"><span class="ln">307  </span></a>
<a name="l308"><span class="ln">308  </span></a>    <span class="s4">@</span><span class="s0">_staticproperty</span>
<a name="l309"><span class="ln">309  </span></a>    <span class="s3">def </span><span class="s0">widgets</span><span class="s4">():</span>
<a name="l310"><span class="ln">310  </span></a>        <span class="s1"># Because this is a static attribute, it will be accessed when initializing this class. In that case, since a user</span>
<a name="l311"><span class="ln">311  </span></a>        <span class="s1"># did not explicitly try to use this attribute, we do not want to throw a deprecation warning.</span>
<a name="l312"><span class="ln">312  </span></a>        <span class="s1"># So we check if the thing calling this static property is one of the known initialization functions in traitlets.</span>
<a name="l313"><span class="ln">313  </span></a>        <span class="s0">frame </span><span class="s4">= </span><span class="s0">_get_frame</span><span class="s4">(</span><span class="s6">2</span><span class="s4">)</span>
<a name="l314"><span class="ln">314  </span></a>        <span class="s3">if not </span><span class="s4">(</span><span class="s0">frame</span><span class="s4">.</span><span class="s0">f_code</span><span class="s4">.</span><span class="s0">co_filename </span><span class="s4">== </span><span class="s0">TRAITLETS_FILE </span><span class="s3">and </span><span class="s4">(</span><span class="s0">frame</span><span class="s4">.</span><span class="s0">f_code</span><span class="s4">.</span><span class="s0">co_name </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'getmembers'</span><span class="s4">, </span><span class="s5">'setup_instance'</span><span class="s4">, </span><span class="s5">'setup_class'</span><span class="s4">))):</span>
<a name="l315"><span class="ln">315  </span></a>            <span class="s0">deprecation</span><span class="s4">(</span><span class="s5">&quot;Widget.widgets is deprecated.&quot;</span><span class="s4">)</span>
<a name="l316"><span class="ln">316  </span></a>        <span class="s3">return </span><span class="s0">_instances</span>
<a name="l317"><span class="ln">317  </span></a>
<a name="l318"><span class="ln">318  </span></a>    <span class="s4">@</span><span class="s0">_staticproperty</span>
<a name="l319"><span class="ln">319  </span></a>    <span class="s3">def </span><span class="s0">_active_widgets</span><span class="s4">():</span>
<a name="l320"><span class="ln">320  </span></a>        <span class="s1"># Because this is a static attribute, it will be accessed when initializing this class. In that case, since a user</span>
<a name="l321"><span class="ln">321  </span></a>        <span class="s1"># did not explicitly try to use this attribute, we do not want to throw a deprecation warning.</span>
<a name="l322"><span class="ln">322  </span></a>        <span class="s1"># So we check if the thing calling this static property is one of the known initialization functions in traitlets.</span>
<a name="l323"><span class="ln">323  </span></a>        <span class="s0">frame </span><span class="s4">= </span><span class="s0">_get_frame</span><span class="s4">(</span><span class="s6">2</span><span class="s4">)</span>
<a name="l324"><span class="ln">324  </span></a>        <span class="s3">if not </span><span class="s4">(</span><span class="s0">frame</span><span class="s4">.</span><span class="s0">f_code</span><span class="s4">.</span><span class="s0">co_filename </span><span class="s4">== </span><span class="s0">TRAITLETS_FILE </span><span class="s3">and </span><span class="s4">(</span><span class="s0">frame</span><span class="s4">.</span><span class="s0">f_code</span><span class="s4">.</span><span class="s0">co_name </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'getmembers'</span><span class="s4">, </span><span class="s5">'setup_instance'</span><span class="s4">, </span><span class="s5">'setup_class'</span><span class="s4">))):</span>
<a name="l325"><span class="ln">325  </span></a>            <span class="s0">deprecation</span><span class="s4">(</span><span class="s5">&quot;Widget._active_widgets is deprecated.&quot;</span><span class="s4">)</span>
<a name="l326"><span class="ln">326  </span></a>        <span class="s3">return </span><span class="s0">_instances</span>
<a name="l327"><span class="ln">327  </span></a>
<a name="l328"><span class="ln">328  </span></a>    <span class="s4">@</span><span class="s0">_staticproperty</span>
<a name="l329"><span class="ln">329  </span></a>    <span class="s3">def </span><span class="s0">_widget_types</span><span class="s4">():</span>
<a name="l330"><span class="ln">330  </span></a>        <span class="s1"># Because this is a static attribute, it will be accessed when initializing this class. In that case, since a user</span>
<a name="l331"><span class="ln">331  </span></a>        <span class="s1"># did not explicitly try to use this attribute, we do not want to throw a deprecation warning.</span>
<a name="l332"><span class="ln">332  </span></a>        <span class="s1"># So we check if the thing calling this static property is one of the known initialization functions in traitlets.</span>
<a name="l333"><span class="ln">333  </span></a>        <span class="s0">frame </span><span class="s4">= </span><span class="s0">_get_frame</span><span class="s4">(</span><span class="s6">2</span><span class="s4">)</span>
<a name="l334"><span class="ln">334  </span></a>        <span class="s3">if not </span><span class="s4">(</span><span class="s0">frame</span><span class="s4">.</span><span class="s0">f_code</span><span class="s4">.</span><span class="s0">co_filename </span><span class="s4">== </span><span class="s0">TRAITLETS_FILE </span><span class="s3">and </span><span class="s4">(</span><span class="s0">frame</span><span class="s4">.</span><span class="s0">f_code</span><span class="s4">.</span><span class="s0">co_name </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'getmembers'</span><span class="s4">, </span><span class="s5">'setup_instance'</span><span class="s4">, </span><span class="s5">'setup_class'</span><span class="s4">))):</span>
<a name="l335"><span class="ln">335  </span></a>            <span class="s0">deprecation</span><span class="s4">(</span><span class="s5">&quot;Widget._widget_types is deprecated.&quot;</span><span class="s4">)</span>
<a name="l336"><span class="ln">336  </span></a>        <span class="s3">return </span><span class="s0">_registry</span>
<a name="l337"><span class="ln">337  </span></a>
<a name="l338"><span class="ln">338  </span></a>    <span class="s4">@</span><span class="s0">_staticproperty</span>
<a name="l339"><span class="ln">339  </span></a>    <span class="s3">def </span><span class="s0">widget_types</span><span class="s4">():</span>
<a name="l340"><span class="ln">340  </span></a>        <span class="s1"># Because this is a static attribute, it will be accessed when initializing this class. In that case, since a user</span>
<a name="l341"><span class="ln">341  </span></a>        <span class="s1"># did not explicitly try to use this attribute, we do not want to throw a deprecation warning.</span>
<a name="l342"><span class="ln">342  </span></a>        <span class="s1"># So we check if the thing calling this static property is one of the known initialization functions in traitlets.</span>
<a name="l343"><span class="ln">343  </span></a>        <span class="s0">frame </span><span class="s4">= </span><span class="s0">_get_frame</span><span class="s4">(</span><span class="s6">2</span><span class="s4">)</span>
<a name="l344"><span class="ln">344  </span></a>        <span class="s3">if not </span><span class="s4">(</span><span class="s0">frame</span><span class="s4">.</span><span class="s0">f_code</span><span class="s4">.</span><span class="s0">co_filename </span><span class="s4">== </span><span class="s0">TRAITLETS_FILE </span><span class="s3">and </span><span class="s4">(</span><span class="s0">frame</span><span class="s4">.</span><span class="s0">f_code</span><span class="s4">.</span><span class="s0">co_name </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'getmembers'</span><span class="s4">, </span><span class="s5">'setup_instance'</span><span class="s4">, </span><span class="s5">'setup_class'</span><span class="s4">))):</span>
<a name="l345"><span class="ln">345  </span></a>            <span class="s0">deprecation</span><span class="s4">(</span><span class="s5">&quot;Widget.widget_types is deprecated.&quot;</span><span class="s4">)</span>
<a name="l346"><span class="ln">346  </span></a>        <span class="s3">return </span><span class="s0">_registry</span>
<a name="l347"><span class="ln">347  </span></a>
<a name="l348"><span class="ln">348  </span></a>    <span class="s4">@</span><span class="s0">classmethod</span>
<a name="l349"><span class="ln">349  </span></a>    <span class="s3">def </span><span class="s0">close_all</span><span class="s4">(</span><span class="s0">cls</span><span class="s4">):</span>
<a name="l350"><span class="ln">350  </span></a>        <span class="s3">for </span><span class="s0">widget </span><span class="s3">in </span><span class="s0">list</span><span class="s4">(</span><span class="s0">_instances</span><span class="s4">.</span><span class="s0">values</span><span class="s4">()):</span>
<a name="l351"><span class="ln">351  </span></a>            <span class="s0">widget</span><span class="s4">.</span><span class="s0">close</span><span class="s4">()</span>
<a name="l352"><span class="ln">352  </span></a>
<a name="l353"><span class="ln">353  </span></a>    <span class="s4">@</span><span class="s0">staticmethod</span>
<a name="l354"><span class="ln">354  </span></a>    <span class="s3">def </span><span class="s0">on_widget_constructed</span><span class="s4">(</span><span class="s0">callback</span><span class="s4">):</span>
<a name="l355"><span class="ln">355  </span></a>        <span class="s2">&quot;&quot;&quot;Registers a callback to be called when a widget is constructed. 
<a name="l356"><span class="ln">356  </span></a> 
<a name="l357"><span class="ln">357  </span></a>        The callback must have the following signature: 
<a name="l358"><span class="ln">358  </span></a>        callback(widget)&quot;&quot;&quot;</span>
<a name="l359"><span class="ln">359  </span></a>        <span class="s0">Widget</span><span class="s4">.</span><span class="s0">_widget_construction_callback </span><span class="s4">= </span><span class="s0">callback</span>
<a name="l360"><span class="ln">360  </span></a>
<a name="l361"><span class="ln">361  </span></a>    <span class="s4">@</span><span class="s0">staticmethod</span>
<a name="l362"><span class="ln">362  </span></a>    <span class="s3">def </span><span class="s0">_call_widget_constructed</span><span class="s4">(</span><span class="s0">widget</span><span class="s4">):</span>
<a name="l363"><span class="ln">363  </span></a>        <span class="s2">&quot;&quot;&quot;Static method, called when a widget is constructed.&quot;&quot;&quot;</span>
<a name="l364"><span class="ln">364  </span></a>        <span class="s3">if </span><span class="s0">Widget</span><span class="s4">.</span><span class="s0">_widget_construction_callback </span><span class="s3">is not None and </span><span class="s0">callable</span><span class="s4">(</span><span class="s0">Widget</span><span class="s4">.</span><span class="s0">_widget_construction_callback</span><span class="s4">):</span>
<a name="l365"><span class="ln">365  </span></a>            <span class="s0">Widget</span><span class="s4">.</span><span class="s0">_widget_construction_callback</span><span class="s4">(</span><span class="s0">widget</span><span class="s4">)</span>
<a name="l366"><span class="ln">366  </span></a>
<a name="l367"><span class="ln">367  </span></a>    <span class="s4">@</span><span class="s0">classmethod</span>
<a name="l368"><span class="ln">368  </span></a>    <span class="s3">def </span><span class="s0">handle_control_comm_opened</span><span class="s4">(</span><span class="s0">cls</span><span class="s4">, </span><span class="s0">comm</span><span class="s4">, </span><span class="s0">msg</span><span class="s4">):</span>
<a name="l369"><span class="ln">369  </span></a>        <span class="s2">&quot;&quot;&quot; 
<a name="l370"><span class="ln">370  </span></a>        Class method, called when the comm-open message on the 
<a name="l371"><span class="ln">371  </span></a>        &quot;jupyter.widget.control&quot; comm channel is received 
<a name="l372"><span class="ln">372  </span></a>        &quot;&quot;&quot;</span>
<a name="l373"><span class="ln">373  </span></a>        <span class="s0">version </span><span class="s4">= </span><span class="s0">msg</span><span class="s4">.</span><span class="s0">get</span><span class="s4">(</span><span class="s5">'metadata'</span><span class="s4">, {}).</span><span class="s0">get</span><span class="s4">(</span><span class="s5">'version'</span><span class="s4">, </span><span class="s5">''</span><span class="s4">)</span>
<a name="l374"><span class="ln">374  </span></a>        <span class="s3">if </span><span class="s0">version</span><span class="s4">.</span><span class="s0">split</span><span class="s4">(</span><span class="s5">'.'</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">] != </span><span class="s0">CONTROL_PROTOCOL_VERSION_MAJOR</span><span class="s4">:</span>
<a name="l375"><span class="ln">375  </span></a>            <span class="s3">raise </span><span class="s0">ValueError</span><span class="s4">(</span><span class="s5">&quot;Incompatible widget control protocol versions: received version %r, expected version %r&quot;</span><span class="s4">%(</span><span class="s0">version</span><span class="s4">, </span><span class="s0">__control_protocol_version__</span><span class="s4">))</span>
<a name="l376"><span class="ln">376  </span></a>
<a name="l377"><span class="ln">377  </span></a>        <span class="s0">cls</span><span class="s4">.</span><span class="s0">_control_comm </span><span class="s4">= </span><span class="s0">comm</span>
<a name="l378"><span class="ln">378  </span></a>        <span class="s0">cls</span><span class="s4">.</span><span class="s0">_control_comm</span><span class="s4">.</span><span class="s0">on_msg</span><span class="s4">(</span><span class="s0">cls</span><span class="s4">.</span><span class="s0">_handle_control_comm_msg</span><span class="s4">)</span>
<a name="l379"><span class="ln">379  </span></a>
<a name="l380"><span class="ln">380  </span></a>    <span class="s4">@</span><span class="s0">classmethod</span>
<a name="l381"><span class="ln">381  </span></a>    <span class="s3">def </span><span class="s0">_handle_control_comm_msg</span><span class="s4">(</span><span class="s0">cls</span><span class="s4">, </span><span class="s0">msg</span><span class="s4">):</span>
<a name="l382"><span class="ln">382  </span></a>        <span class="s1"># This shouldn't happen unless someone calls this method manually</span>
<a name="l383"><span class="ln">383  </span></a>        <span class="s3">if </span><span class="s0">cls</span><span class="s4">.</span><span class="s0">_control_comm </span><span class="s3">is None</span><span class="s4">:</span>
<a name="l384"><span class="ln">384  </span></a>            <span class="s3">raise </span><span class="s0">RuntimeError</span><span class="s4">(</span><span class="s5">'Control comm has not been properly opened'</span><span class="s4">)</span>
<a name="l385"><span class="ln">385  </span></a>
<a name="l386"><span class="ln">386  </span></a>        <span class="s0">data </span><span class="s4">= </span><span class="s0">msg</span><span class="s4">[</span><span class="s5">'content'</span><span class="s4">][</span><span class="s5">'data'</span><span class="s4">]</span>
<a name="l387"><span class="ln">387  </span></a>        <span class="s0">method </span><span class="s4">= </span><span class="s0">data</span><span class="s4">[</span><span class="s5">'method'</span><span class="s4">]</span>
<a name="l388"><span class="ln">388  </span></a>
<a name="l389"><span class="ln">389  </span></a>        <span class="s3">if </span><span class="s0">method </span><span class="s4">== </span><span class="s5">'request_states'</span><span class="s4">:</span>
<a name="l390"><span class="ln">390  </span></a>            <span class="s1"># Send back the full widgets state</span>
<a name="l391"><span class="ln">391  </span></a>            <span class="s0">cls</span><span class="s4">.</span><span class="s0">get_manager_state</span><span class="s4">()</span>
<a name="l392"><span class="ln">392  </span></a>            <span class="s0">widgets </span><span class="s4">= </span><span class="s0">_instances</span><span class="s4">.</span><span class="s0">values</span><span class="s4">()</span>
<a name="l393"><span class="ln">393  </span></a>            <span class="s0">full_state </span><span class="s4">= {}</span>
<a name="l394"><span class="ln">394  </span></a>            <span class="s0">drop_defaults </span><span class="s4">= </span><span class="s3">False</span>
<a name="l395"><span class="ln">395  </span></a>            <span class="s3">for </span><span class="s0">widget </span><span class="s3">in </span><span class="s0">widgets</span><span class="s4">:</span>
<a name="l396"><span class="ln">396  </span></a>                <span class="s0">full_state</span><span class="s4">[</span><span class="s0">widget</span><span class="s4">.</span><span class="s0">model_id</span><span class="s4">] = {</span>
<a name="l397"><span class="ln">397  </span></a>                    <span class="s5">'model_name'</span><span class="s4">: </span><span class="s0">widget</span><span class="s4">.</span><span class="s0">_model_name</span><span class="s4">,</span>
<a name="l398"><span class="ln">398  </span></a>                    <span class="s5">'model_module'</span><span class="s4">: </span><span class="s0">widget</span><span class="s4">.</span><span class="s0">_model_module</span><span class="s4">,</span>
<a name="l399"><span class="ln">399  </span></a>                    <span class="s5">'model_module_version'</span><span class="s4">: </span><span class="s0">widget</span><span class="s4">.</span><span class="s0">_model_module_version</span><span class="s4">,</span>
<a name="l400"><span class="ln">400  </span></a>                    <span class="s5">'state'</span><span class="s4">: </span><span class="s0">widget</span><span class="s4">.</span><span class="s0">get_state</span><span class="s4">(</span><span class="s0">drop_defaults</span><span class="s4">=</span><span class="s0">drop_defaults</span><span class="s4">),</span>
<a name="l401"><span class="ln">401  </span></a>                <span class="s4">}</span>
<a name="l402"><span class="ln">402  </span></a>            <span class="s0">full_state</span><span class="s4">, </span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers </span><span class="s4">= </span><span class="s0">_remove_buffers</span><span class="s4">(</span><span class="s0">full_state</span><span class="s4">)</span>
<a name="l403"><span class="ln">403  </span></a>            <span class="s0">cls</span><span class="s4">.</span><span class="s0">_control_comm</span><span class="s4">.</span><span class="s0">send</span><span class="s4">(</span><span class="s0">dict</span><span class="s4">(</span>
<a name="l404"><span class="ln">404  </span></a>                <span class="s0">method</span><span class="s4">=</span><span class="s5">'update_states'</span><span class="s4">,</span>
<a name="l405"><span class="ln">405  </span></a>                <span class="s0">states</span><span class="s4">=</span><span class="s0">full_state</span><span class="s4">,</span>
<a name="l406"><span class="ln">406  </span></a>                <span class="s0">buffer_paths</span><span class="s4">=</span><span class="s0">buffer_paths</span>
<a name="l407"><span class="ln">407  </span></a>            <span class="s4">), </span><span class="s0">buffers</span><span class="s4">=</span><span class="s0">buffers</span><span class="s4">)</span>
<a name="l408"><span class="ln">408  </span></a>
<a name="l409"><span class="ln">409  </span></a>        <span class="s3">else</span><span class="s4">:</span>
<a name="l410"><span class="ln">410  </span></a>            <span class="s3">raise </span><span class="s0">RuntimeError</span><span class="s4">(</span><span class="s5">'Unknown front-end to back-end widget control msg with method &quot;%s&quot;' </span><span class="s4">% </span><span class="s0">method</span><span class="s4">)</span>
<a name="l411"><span class="ln">411  </span></a>
<a name="l412"><span class="ln">412  </span></a>    <span class="s4">@</span><span class="s0">staticmethod</span>
<a name="l413"><span class="ln">413  </span></a>    <span class="s3">def </span><span class="s0">handle_comm_opened</span><span class="s4">(</span><span class="s0">comm</span><span class="s4">, </span><span class="s0">msg</span><span class="s4">):</span>
<a name="l414"><span class="ln">414  </span></a>        <span class="s2">&quot;&quot;&quot;Static method, called when a widget is constructed.&quot;&quot;&quot;</span>
<a name="l415"><span class="ln">415  </span></a>        <span class="s0">version </span><span class="s4">= </span><span class="s0">msg</span><span class="s4">.</span><span class="s0">get</span><span class="s4">(</span><span class="s5">'metadata'</span><span class="s4">, {}).</span><span class="s0">get</span><span class="s4">(</span><span class="s5">'version'</span><span class="s4">, </span><span class="s5">''</span><span class="s4">)</span>
<a name="l416"><span class="ln">416  </span></a>        <span class="s3">if </span><span class="s0">version</span><span class="s4">.</span><span class="s0">split</span><span class="s4">(</span><span class="s5">'.'</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">] != </span><span class="s0">PROTOCOL_VERSION_MAJOR</span><span class="s4">:</span>
<a name="l417"><span class="ln">417  </span></a>            <span class="s3">raise </span><span class="s0">ValueError</span><span class="s4">(</span><span class="s5">&quot;Incompatible widget protocol versions: received version %r, expected version %r&quot;</span><span class="s4">%(</span><span class="s0">version</span><span class="s4">, </span><span class="s0">__protocol_version__</span><span class="s4">))</span>
<a name="l418"><span class="ln">418  </span></a>        <span class="s0">data </span><span class="s4">= </span><span class="s0">msg</span><span class="s4">[</span><span class="s5">'content'</span><span class="s4">][</span><span class="s5">'data'</span><span class="s4">]</span>
<a name="l419"><span class="ln">419  </span></a>        <span class="s0">state </span><span class="s4">= </span><span class="s0">data</span><span class="s4">[</span><span class="s5">'state'</span><span class="s4">]</span>
<a name="l420"><span class="ln">420  </span></a>
<a name="l421"><span class="ln">421  </span></a>        <span class="s1"># Find the widget class to instantiate in the registered widgets</span>
<a name="l422"><span class="ln">422  </span></a>        <span class="s0">widget_class </span><span class="s4">= </span><span class="s0">_registry</span><span class="s4">.</span><span class="s0">get</span><span class="s4">(</span><span class="s0">state</span><span class="s4">[</span><span class="s5">'_model_module'</span><span class="s4">],</span>
<a name="l423"><span class="ln">423  </span></a>                                               <span class="s0">state</span><span class="s4">[</span><span class="s5">'_model_module_version'</span><span class="s4">],</span>
<a name="l424"><span class="ln">424  </span></a>                                               <span class="s0">state</span><span class="s4">[</span><span class="s5">'_model_name'</span><span class="s4">],</span>
<a name="l425"><span class="ln">425  </span></a>                                               <span class="s0">state</span><span class="s4">[</span><span class="s5">'_view_module'</span><span class="s4">],</span>
<a name="l426"><span class="ln">426  </span></a>                                               <span class="s0">state</span><span class="s4">[</span><span class="s5">'_view_module_version'</span><span class="s4">],</span>
<a name="l427"><span class="ln">427  </span></a>                                               <span class="s0">state</span><span class="s4">[</span><span class="s5">'_view_name'</span><span class="s4">])</span>
<a name="l428"><span class="ln">428  </span></a>        <span class="s0">widget </span><span class="s4">= </span><span class="s0">widget_class</span><span class="s4">(</span><span class="s0">comm</span><span class="s4">=</span><span class="s0">comm</span><span class="s4">)</span>
<a name="l429"><span class="ln">429  </span></a>        <span class="s3">if </span><span class="s5">'buffer_paths' </span><span class="s3">in </span><span class="s0">data</span><span class="s4">:</span>
<a name="l430"><span class="ln">430  </span></a>            <span class="s0">_put_buffers</span><span class="s4">(</span><span class="s0">state</span><span class="s4">, </span><span class="s0">data</span><span class="s4">[</span><span class="s5">'buffer_paths'</span><span class="s4">], </span><span class="s0">msg</span><span class="s4">[</span><span class="s5">'buffers'</span><span class="s4">])</span>
<a name="l431"><span class="ln">431  </span></a>        <span class="s0">widget</span><span class="s4">.</span><span class="s0">set_state</span><span class="s4">(</span><span class="s0">state</span><span class="s4">)</span>
<a name="l432"><span class="ln">432  </span></a>
<a name="l433"><span class="ln">433  </span></a>    <span class="s4">@</span><span class="s0">staticmethod</span>
<a name="l434"><span class="ln">434  </span></a>    <span class="s3">def </span><span class="s0">get_manager_state</span><span class="s4">(</span><span class="s0">drop_defaults</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s0">widgets</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
<a name="l435"><span class="ln">435  </span></a>        <span class="s2">&quot;&quot;&quot;Returns the full state for a widget manager for embedding 
<a name="l436"><span class="ln">436  </span></a> 
<a name="l437"><span class="ln">437  </span></a>        :param drop_defaults: when True, it will not include default value 
<a name="l438"><span class="ln">438  </span></a>        :param widgets: list with widgets to include in the state (or all widgets when None) 
<a name="l439"><span class="ln">439  </span></a>        :return: 
<a name="l440"><span class="ln">440  </span></a>        &quot;&quot;&quot;</span>
<a name="l441"><span class="ln">441  </span></a>        <span class="s0">state </span><span class="s4">= {}</span>
<a name="l442"><span class="ln">442  </span></a>        <span class="s3">if </span><span class="s0">widgets </span><span class="s3">is None</span><span class="s4">:</span>
<a name="l443"><span class="ln">443  </span></a>            <span class="s0">widgets </span><span class="s4">= </span><span class="s0">_instances</span><span class="s4">.</span><span class="s0">values</span><span class="s4">()</span>
<a name="l444"><span class="ln">444  </span></a>        <span class="s3">for </span><span class="s0">widget </span><span class="s3">in </span><span class="s0">widgets</span><span class="s4">:</span>
<a name="l445"><span class="ln">445  </span></a>            <span class="s0">state</span><span class="s4">[</span><span class="s0">widget</span><span class="s4">.</span><span class="s0">model_id</span><span class="s4">] = </span><span class="s0">widget</span><span class="s4">.</span><span class="s0">_get_embed_state</span><span class="s4">(</span><span class="s0">drop_defaults</span><span class="s4">=</span><span class="s0">drop_defaults</span><span class="s4">)</span>
<a name="l446"><span class="ln">446  </span></a>        <span class="s3">return </span><span class="s4">{</span><span class="s5">'version_major'</span><span class="s4">: </span><span class="s6">2</span><span class="s4">, </span><span class="s5">'version_minor'</span><span class="s4">: </span><span class="s6">0</span><span class="s4">, </span><span class="s5">'state'</span><span class="s4">: </span><span class="s0">state</span><span class="s4">}</span>
<a name="l447"><span class="ln">447  </span></a>
<a name="l448"><span class="ln">448  </span></a>    <span class="s3">def </span><span class="s0">_get_embed_state</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">drop_defaults</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
<a name="l449"><span class="ln">449  </span></a>        <span class="s0">state </span><span class="s4">= {</span>
<a name="l450"><span class="ln">450  </span></a>            <span class="s5">'model_name'</span><span class="s4">: </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_model_name</span><span class="s4">,</span>
<a name="l451"><span class="ln">451  </span></a>            <span class="s5">'model_module'</span><span class="s4">: </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_model_module</span><span class="s4">,</span>
<a name="l452"><span class="ln">452  </span></a>            <span class="s5">'model_module_version'</span><span class="s4">: </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_model_module_version</span>
<a name="l453"><span class="ln">453  </span></a>        <span class="s4">}</span>
<a name="l454"><span class="ln">454  </span></a>        <span class="s0">model_state</span><span class="s4">, </span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers </span><span class="s4">= </span><span class="s0">_remove_buffers</span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">get_state</span><span class="s4">(</span><span class="s0">drop_defaults</span><span class="s4">=</span><span class="s0">drop_defaults</span><span class="s4">))</span>
<a name="l455"><span class="ln">455  </span></a>        <span class="s0">state</span><span class="s4">[</span><span class="s5">'state'</span><span class="s4">] = </span><span class="s0">model_state</span>
<a name="l456"><span class="ln">456  </span></a>        <span class="s3">if </span><span class="s0">len</span><span class="s4">(</span><span class="s0">buffers</span><span class="s4">) &gt; </span><span class="s6">0</span><span class="s4">:</span>
<a name="l457"><span class="ln">457  </span></a>            <span class="s0">state</span><span class="s4">[</span><span class="s5">'buffers'</span><span class="s4">] = [{</span><span class="s5">'encoding'</span><span class="s4">: </span><span class="s5">'base64'</span><span class="s4">,</span>
<a name="l458"><span class="ln">458  </span></a>                                 <span class="s5">'path'</span><span class="s4">: </span><span class="s0">p</span><span class="s4">,</span>
<a name="l459"><span class="ln">459  </span></a>                                 <span class="s5">'data'</span><span class="s4">: </span><span class="s0">standard_b64encode</span><span class="s4">(</span><span class="s0">d</span><span class="s4">).</span><span class="s0">decode</span><span class="s4">(</span><span class="s5">'ascii'</span><span class="s4">)}</span>
<a name="l460"><span class="ln">460  </span></a>                                <span class="s3">for </span><span class="s0">p</span><span class="s4">, </span><span class="s0">d </span><span class="s3">in </span><span class="s0">zip</span><span class="s4">(</span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">)]</span>
<a name="l461"><span class="ln">461  </span></a>        <span class="s3">return </span><span class="s0">state</span>
<a name="l462"><span class="ln">462  </span></a>
<a name="l463"><span class="ln">463  </span></a>    <span class="s3">def </span><span class="s0">get_view_spec</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l464"><span class="ln">464  </span></a>        <span class="s3">return </span><span class="s0">dict</span><span class="s4">(</span><span class="s0">version_major</span><span class="s4">=</span><span class="s6">2</span><span class="s4">, </span><span class="s0">version_minor</span><span class="s4">=</span><span class="s6">0</span><span class="s4">, </span><span class="s0">model_id</span><span class="s4">=</span><span class="s0">self</span><span class="s4">.</span><span class="s0">_model_id</span><span class="s4">)</span>
<a name="l465"><span class="ln">465  </span></a>
<a name="l466"><span class="ln">466  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l467"><span class="ln">467  </span></a>    <span class="s1"># Traits</span>
<a name="l468"><span class="ln">468  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l469"><span class="ln">469  </span></a>    <span class="s0">_model_name </span><span class="s4">= </span><span class="s0">Unicode</span><span class="s4">(</span><span class="s5">'WidgetModel'</span><span class="s4">,</span>
<a name="l470"><span class="ln">470  </span></a>        <span class="s0">help</span><span class="s4">=</span><span class="s5">&quot;Name of the model.&quot;</span><span class="s4">, </span><span class="s0">read_only</span><span class="s4">=</span><span class="s3">True</span><span class="s4">).</span><span class="s0">tag</span><span class="s4">(</span><span class="s0">sync</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l471"><span class="ln">471  </span></a>    <span class="s0">_model_module </span><span class="s4">= </span><span class="s0">Unicode</span><span class="s4">(</span><span class="s5">'@jupyter-widgets/base'</span><span class="s4">,</span>
<a name="l472"><span class="ln">472  </span></a>        <span class="s0">help</span><span class="s4">=</span><span class="s5">&quot;The namespace for the model.&quot;</span><span class="s4">, </span><span class="s0">read_only</span><span class="s4">=</span><span class="s3">True</span><span class="s4">).</span><span class="s0">tag</span><span class="s4">(</span><span class="s0">sync</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l473"><span class="ln">473  </span></a>    <span class="s0">_model_module_version </span><span class="s4">= </span><span class="s0">Unicode</span><span class="s4">(</span><span class="s0">__jupyter_widgets_base_version__</span><span class="s4">,</span>
<a name="l474"><span class="ln">474  </span></a>        <span class="s0">help</span><span class="s4">=</span><span class="s5">&quot;A semver requirement for namespace version containing the model.&quot;</span><span class="s4">, </span><span class="s0">read_only</span><span class="s4">=</span><span class="s3">True</span><span class="s4">).</span><span class="s0">tag</span><span class="s4">(</span><span class="s0">sync</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l475"><span class="ln">475  </span></a>    <span class="s0">_view_name </span><span class="s4">= </span><span class="s0">Unicode</span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s0">allow_none</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
<a name="l476"><span class="ln">476  </span></a>        <span class="s0">help</span><span class="s4">=</span><span class="s5">&quot;Name of the view.&quot;</span><span class="s4">).</span><span class="s0">tag</span><span class="s4">(</span><span class="s0">sync</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l477"><span class="ln">477  </span></a>    <span class="s0">_view_module </span><span class="s4">= </span><span class="s0">Unicode</span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s0">allow_none</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
<a name="l478"><span class="ln">478  </span></a>        <span class="s0">help</span><span class="s4">=</span><span class="s5">&quot;The namespace for the view.&quot;</span><span class="s4">).</span><span class="s0">tag</span><span class="s4">(</span><span class="s0">sync</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l479"><span class="ln">479  </span></a>    <span class="s0">_view_module_version </span><span class="s4">= </span><span class="s0">Unicode</span><span class="s4">(</span><span class="s5">''</span><span class="s4">,</span>
<a name="l480"><span class="ln">480  </span></a>        <span class="s0">help</span><span class="s4">=</span><span class="s5">&quot;A semver requirement for the namespace version containing the view.&quot;</span><span class="s4">).</span><span class="s0">tag</span><span class="s4">(</span><span class="s0">sync</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l481"><span class="ln">481  </span></a>
<a name="l482"><span class="ln">482  </span></a>    <span class="s0">_view_count </span><span class="s4">= </span><span class="s0">Int</span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s0">allow_none</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
<a name="l483"><span class="ln">483  </span></a>        <span class="s0">help</span><span class="s4">=</span><span class="s5">&quot;EXPERIMENTAL: The number of views of the model displayed in the frontend. This attribute is experimental and may change or be removed in the future. None signifies that views will not be tracked. Set this to 0 to start tracking view creation/deletion.&quot;</span><span class="s4">).</span><span class="s0">tag</span><span class="s4">(</span><span class="s0">sync</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l484"><span class="ln">484  </span></a>    <span class="s0">comm </span><span class="s4">= </span><span class="s0">Any</span><span class="s4">(</span><span class="s0">allow_none</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<a name="l485"><span class="ln">485  </span></a>
<a name="l486"><span class="ln">486  </span></a>    <span class="s0">keys </span><span class="s4">= </span><span class="s0">List</span><span class="s4">(</span><span class="s0">help</span><span class="s4">=</span><span class="s5">&quot;The traits which are synced.&quot;</span><span class="s4">)</span>
<a name="l487"><span class="ln">487  </span></a>
<a name="l488"><span class="ln">488  </span></a>    <span class="s4">@</span><span class="s0">default</span><span class="s4">(</span><span class="s5">'keys'</span><span class="s4">)</span>
<a name="l489"><span class="ln">489  </span></a>    <span class="s3">def </span><span class="s0">_default_keys</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l490"><span class="ln">490  </span></a>        <span class="s3">return </span><span class="s4">[</span><span class="s0">name </span><span class="s3">for </span><span class="s0">name </span><span class="s3">in </span><span class="s0">self</span><span class="s4">.</span><span class="s0">traits</span><span class="s4">(</span><span class="s0">sync</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)]</span>
<a name="l491"><span class="ln">491  </span></a>
<a name="l492"><span class="ln">492  </span></a>    <span class="s0">_property_lock </span><span class="s4">= </span><span class="s0">Dict</span><span class="s4">()</span>
<a name="l493"><span class="ln">493  </span></a>    <span class="s0">_holding_sync </span><span class="s4">= </span><span class="s3">False</span>
<a name="l494"><span class="ln">494  </span></a>    <span class="s0">_states_to_send </span><span class="s4">= </span><span class="s0">Set</span><span class="s4">()</span>
<a name="l495"><span class="ln">495  </span></a>    <span class="s0">_msg_callbacks </span><span class="s4">= </span><span class="s0">Instance</span><span class="s4">(</span><span class="s0">CallbackDispatcher</span><span class="s4">, ())</span>
<a name="l496"><span class="ln">496  </span></a>
<a name="l497"><span class="ln">497  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l498"><span class="ln">498  </span></a>    <span class="s1"># (Con/de)structor</span>
<a name="l499"><span class="ln">499  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l500"><span class="ln">500  </span></a>    <span class="s3">def </span><span class="s0">__init__</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, **</span><span class="s0">kwargs</span><span class="s4">):</span>
<a name="l501"><span class="ln">501  </span></a>        <span class="s2">&quot;&quot;&quot;Public constructor&quot;&quot;&quot;</span>
<a name="l502"><span class="ln">502  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">_model_id </span><span class="s4">= </span><span class="s0">kwargs</span><span class="s4">.</span><span class="s0">pop</span><span class="s4">(</span><span class="s5">'model_id'</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
<a name="l503"><span class="ln">503  </span></a>        <span class="s0">super</span><span class="s4">().</span><span class="s0">__init__</span><span class="s4">(**</span><span class="s0">kwargs</span><span class="s4">)</span>
<a name="l504"><span class="ln">504  </span></a>
<a name="l505"><span class="ln">505  </span></a>        <span class="s0">Widget</span><span class="s4">.</span><span class="s0">_call_widget_constructed</span><span class="s4">(</span><span class="s0">self</span><span class="s4">)</span>
<a name="l506"><span class="ln">506  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">open</span><span class="s4">()</span>
<a name="l507"><span class="ln">507  </span></a>    
<a name="l508"><span class="ln">508  </span></a>    <span class="s3">def </span><span class="s0">__copy__</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l509"><span class="ln">509  </span></a>        <span class="s3">raise </span><span class="s0">NotImplementedError</span><span class="s4">(</span><span class="s5">&quot;Widgets cannot be copied; custom implementation required&quot;</span><span class="s4">)</span>
<a name="l510"><span class="ln">510  </span></a>
<a name="l511"><span class="ln">511  </span></a>    <span class="s3">def </span><span class="s0">__deepcopy__</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">memo</span><span class="s4">):</span>
<a name="l512"><span class="ln">512  </span></a>        <span class="s3">raise </span><span class="s0">NotImplementedError</span><span class="s4">(</span><span class="s5">&quot;Widgets cannot be copied; custom implementation required&quot;</span><span class="s4">)</span>
<a name="l513"><span class="ln">513  </span></a>
<a name="l514"><span class="ln">514  </span></a>    <span class="s3">def </span><span class="s0">__del__</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l515"><span class="ln">515  </span></a>        <span class="s2">&quot;&quot;&quot;Object disposal&quot;&quot;&quot;</span>
<a name="l516"><span class="ln">516  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">close</span><span class="s4">()</span>
<a name="l517"><span class="ln">517  </span></a>
<a name="l518"><span class="ln">518  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l519"><span class="ln">519  </span></a>    <span class="s1"># Properties</span>
<a name="l520"><span class="ln">520  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l521"><span class="ln">521  </span></a>
<a name="l522"><span class="ln">522  </span></a>    <span class="s3">def </span><span class="s0">open</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l523"><span class="ln">523  </span></a>        <span class="s2">&quot;&quot;&quot;Open a comm to the frontend if one isn't already open.&quot;&quot;&quot;</span>
<a name="l524"><span class="ln">524  </span></a>        <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">comm </span><span class="s3">is None</span><span class="s4">:</span>
<a name="l525"><span class="ln">525  </span></a>            <span class="s0">state</span><span class="s4">, </span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers </span><span class="s4">= </span><span class="s0">_remove_buffers</span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">get_state</span><span class="s4">())</span>
<a name="l526"><span class="ln">526  </span></a>
<a name="l527"><span class="ln">527  </span></a>            <span class="s0">args </span><span class="s4">= </span><span class="s0">dict</span><span class="s4">(</span><span class="s0">target_name</span><span class="s4">=</span><span class="s5">'jupyter.widget'</span><span class="s4">,</span>
<a name="l528"><span class="ln">528  </span></a>                        <span class="s0">data</span><span class="s4">={</span><span class="s5">'state'</span><span class="s4">: </span><span class="s0">state</span><span class="s4">, </span><span class="s5">'buffer_paths'</span><span class="s4">: </span><span class="s0">buffer_paths</span><span class="s4">},</span>
<a name="l529"><span class="ln">529  </span></a>                        <span class="s0">buffers</span><span class="s4">=</span><span class="s0">buffers</span><span class="s4">,</span>
<a name="l530"><span class="ln">530  </span></a>                        <span class="s0">metadata</span><span class="s4">={</span><span class="s5">'version'</span><span class="s4">: </span><span class="s0">__protocol_version__</span><span class="s4">}</span>
<a name="l531"><span class="ln">531  </span></a>                        <span class="s4">)</span>
<a name="l532"><span class="ln">532  </span></a>            <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_model_id </span><span class="s3">is not None</span><span class="s4">:</span>
<a name="l533"><span class="ln">533  </span></a>                <span class="s0">args</span><span class="s4">[</span><span class="s5">'comm_id'</span><span class="s4">] = </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_model_id</span>
<a name="l534"><span class="ln">534  </span></a>
<a name="l535"><span class="ln">535  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">comm </span><span class="s4">= </span><span class="s0">comm</span><span class="s4">.</span><span class="s0">create_comm</span><span class="s4">(**</span><span class="s0">args</span><span class="s4">)</span>
<a name="l536"><span class="ln">536  </span></a>
<a name="l537"><span class="ln">537  </span></a>    <span class="s4">@</span><span class="s0">observe</span><span class="s4">(</span><span class="s5">'comm'</span><span class="s4">)</span>
<a name="l538"><span class="ln">538  </span></a>    <span class="s3">def </span><span class="s0">_comm_changed</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">change</span><span class="s4">):</span>
<a name="l539"><span class="ln">539  </span></a>        <span class="s2">&quot;&quot;&quot;Called when the comm is changed.&quot;&quot;&quot;</span>
<a name="l540"><span class="ln">540  </span></a>        <span class="s3">if </span><span class="s0">change</span><span class="s4">[</span><span class="s5">'new'</span><span class="s4">] </span><span class="s3">is None</span><span class="s4">:</span>
<a name="l541"><span class="ln">541  </span></a>            <span class="s3">return</span>
<a name="l542"><span class="ln">542  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">_model_id </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">model_id</span>
<a name="l543"><span class="ln">543  </span></a>
<a name="l544"><span class="ln">544  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">comm</span><span class="s4">.</span><span class="s0">on_msg</span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">_handle_msg</span><span class="s4">)</span>
<a name="l545"><span class="ln">545  </span></a>        <span class="s0">_instances</span><span class="s4">[</span><span class="s0">self</span><span class="s4">.</span><span class="s0">model_id</span><span class="s4">] = </span><span class="s0">self</span>
<a name="l546"><span class="ln">546  </span></a>
<a name="l547"><span class="ln">547  </span></a>    <span class="s4">@</span><span class="s0">property</span>
<a name="l548"><span class="ln">548  </span></a>    <span class="s3">def </span><span class="s0">model_id</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l549"><span class="ln">549  </span></a>        <span class="s2">&quot;&quot;&quot;Gets the model id of this widget. 
<a name="l550"><span class="ln">550  </span></a> 
<a name="l551"><span class="ln">551  </span></a>        If a Comm doesn't exist yet, a Comm will be created automagically.&quot;&quot;&quot;</span>
<a name="l552"><span class="ln">552  </span></a>        <span class="s3">return </span><span class="s0">self</span><span class="s4">.</span><span class="s0">comm</span><span class="s4">.</span><span class="s0">comm_id</span>
<a name="l553"><span class="ln">553  </span></a>
<a name="l554"><span class="ln">554  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l555"><span class="ln">555  </span></a>    <span class="s1"># Methods</span>
<a name="l556"><span class="ln">556  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l557"><span class="ln">557  </span></a>
<a name="l558"><span class="ln">558  </span></a>    <span class="s3">def </span><span class="s0">close</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l559"><span class="ln">559  </span></a>        <span class="s2">&quot;&quot;&quot;Close method. 
<a name="l560"><span class="ln">560  </span></a> 
<a name="l561"><span class="ln">561  </span></a>        Closes the underlying comm. 
<a name="l562"><span class="ln">562  </span></a>        When the comm is closed, all of the widget views are automatically 
<a name="l563"><span class="ln">563  </span></a>        removed from the front-end.&quot;&quot;&quot;</span>
<a name="l564"><span class="ln">564  </span></a>        <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">comm </span><span class="s3">is not None</span><span class="s4">:</span>
<a name="l565"><span class="ln">565  </span></a>            <span class="s0">_instances</span><span class="s4">.</span><span class="s0">pop</span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">model_id</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
<a name="l566"><span class="ln">566  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">comm</span><span class="s4">.</span><span class="s0">close</span><span class="s4">()</span>
<a name="l567"><span class="ln">567  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">comm </span><span class="s4">= </span><span class="s3">None</span>
<a name="l568"><span class="ln">568  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">_repr_mimebundle_ </span><span class="s4">= </span><span class="s3">None</span>
<a name="l569"><span class="ln">569  </span></a>
<a name="l570"><span class="ln">570  </span></a>    <span class="s3">def </span><span class="s0">send_state</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">key</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
<a name="l571"><span class="ln">571  </span></a>        <span class="s2">&quot;&quot;&quot;Sends the widget state, or a piece of it, to the front-end, if it exists. 
<a name="l572"><span class="ln">572  </span></a> 
<a name="l573"><span class="ln">573  </span></a>        Parameters 
<a name="l574"><span class="ln">574  </span></a>        ---------- 
<a name="l575"><span class="ln">575  </span></a>        key : unicode, or iterable (optional) 
<a name="l576"><span class="ln">576  </span></a>            A single property's name or iterable of property names to sync with the front-end. 
<a name="l577"><span class="ln">577  </span></a>        &quot;&quot;&quot;</span>
<a name="l578"><span class="ln">578  </span></a>        <span class="s0">state </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">get_state</span><span class="s4">(</span><span class="s0">key</span><span class="s4">=</span><span class="s0">key</span><span class="s4">)</span>
<a name="l579"><span class="ln">579  </span></a>        <span class="s3">if </span><span class="s0">len</span><span class="s4">(</span><span class="s0">state</span><span class="s4">) &gt; </span><span class="s6">0</span><span class="s4">:</span>
<a name="l580"><span class="ln">580  </span></a>            <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_property_lock</span><span class="s4">:  </span><span class="s1"># we need to keep this dict up to date with the front-end values</span>
<a name="l581"><span class="ln">581  </span></a>                <span class="s3">for </span><span class="s0">name</span><span class="s4">, </span><span class="s0">value </span><span class="s3">in </span><span class="s0">state</span><span class="s4">.</span><span class="s0">items</span><span class="s4">():</span>
<a name="l582"><span class="ln">582  </span></a>                    <span class="s3">if </span><span class="s0">name </span><span class="s3">in </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_property_lock</span><span class="s4">:</span>
<a name="l583"><span class="ln">583  </span></a>                        <span class="s0">self</span><span class="s4">.</span><span class="s0">_property_lock</span><span class="s4">[</span><span class="s0">name</span><span class="s4">] = </span><span class="s0">value</span>
<a name="l584"><span class="ln">584  </span></a>            <span class="s0">state</span><span class="s4">, </span><span class="s0">buffer_paths</span><span class="s4">, </span><span class="s0">buffers </span><span class="s4">= </span><span class="s0">_remove_buffers</span><span class="s4">(</span><span class="s0">state</span><span class="s4">)</span>
<a name="l585"><span class="ln">585  </span></a>            <span class="s0">msg </span><span class="s4">= {</span><span class="s5">'method'</span><span class="s4">: </span><span class="s5">'update'</span><span class="s4">, </span><span class="s5">'state'</span><span class="s4">: </span><span class="s0">state</span><span class="s4">, </span><span class="s5">'buffer_paths'</span><span class="s4">: </span><span class="s0">buffer_paths</span><span class="s4">}</span>
<a name="l586"><span class="ln">586  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">_send</span><span class="s4">(</span><span class="s0">msg</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">=</span><span class="s0">buffers</span><span class="s4">)</span>
<a name="l587"><span class="ln">587  </span></a>
<a name="l588"><span class="ln">588  </span></a>
<a name="l589"><span class="ln">589  </span></a>    <span class="s3">def </span><span class="s0">get_state</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">key</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s0">drop_defaults</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
<a name="l590"><span class="ln">590  </span></a>        <span class="s2">&quot;&quot;&quot;Gets the widget state, or a piece of it. 
<a name="l591"><span class="ln">591  </span></a> 
<a name="l592"><span class="ln">592  </span></a>        Parameters 
<a name="l593"><span class="ln">593  </span></a>        ---------- 
<a name="l594"><span class="ln">594  </span></a>        key : unicode or iterable (optional) 
<a name="l595"><span class="ln">595  </span></a>            A single property's name or iterable of property names to get. 
<a name="l596"><span class="ln">596  </span></a> 
<a name="l597"><span class="ln">597  </span></a>        Returns 
<a name="l598"><span class="ln">598  </span></a>        ------- 
<a name="l599"><span class="ln">599  </span></a>        state : dict of states 
<a name="l600"><span class="ln">600  </span></a>        metadata : dict 
<a name="l601"><span class="ln">601  </span></a>            metadata for each field: {key: metadata} 
<a name="l602"><span class="ln">602  </span></a>        &quot;&quot;&quot;</span>
<a name="l603"><span class="ln">603  </span></a>        <span class="s3">if </span><span class="s0">key </span><span class="s3">is None</span><span class="s4">:</span>
<a name="l604"><span class="ln">604  </span></a>            <span class="s0">keys </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">keys</span>
<a name="l605"><span class="ln">605  </span></a>        <span class="s3">elif </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">key</span><span class="s4">, </span><span class="s0">str</span><span class="s4">):</span>
<a name="l606"><span class="ln">606  </span></a>            <span class="s0">keys </span><span class="s4">= [</span><span class="s0">key</span><span class="s4">]</span>
<a name="l607"><span class="ln">607  </span></a>        <span class="s3">elif </span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">key</span><span class="s4">, </span><span class="s0">Iterable</span><span class="s4">):</span>
<a name="l608"><span class="ln">608  </span></a>            <span class="s0">keys </span><span class="s4">= </span><span class="s0">key</span>
<a name="l609"><span class="ln">609  </span></a>        <span class="s3">else</span><span class="s4">:</span>
<a name="l610"><span class="ln">610  </span></a>            <span class="s3">raise </span><span class="s0">ValueError</span><span class="s4">(</span><span class="s5">&quot;key must be a string, an iterable of keys, or None&quot;</span><span class="s4">)</span>
<a name="l611"><span class="ln">611  </span></a>        <span class="s0">state </span><span class="s4">= {}</span>
<a name="l612"><span class="ln">612  </span></a>        <span class="s0">traits </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">traits</span><span class="s4">()</span>
<a name="l613"><span class="ln">613  </span></a>        <span class="s3">for </span><span class="s0">k </span><span class="s3">in </span><span class="s0">keys</span><span class="s4">:</span>
<a name="l614"><span class="ln">614  </span></a>            <span class="s0">to_json </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">trait_metadata</span><span class="s4">(</span><span class="s0">k</span><span class="s4">, </span><span class="s5">'to_json'</span><span class="s4">, </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_trait_to_json</span><span class="s4">)</span>
<a name="l615"><span class="ln">615  </span></a>            <span class="s0">value </span><span class="s4">= </span><span class="s0">to_json</span><span class="s4">(</span><span class="s0">getattr</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">k</span><span class="s4">), </span><span class="s0">self</span><span class="s4">)</span>
<a name="l616"><span class="ln">616  </span></a>            <span class="s3">if not </span><span class="s0">drop_defaults </span><span class="s3">or not </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_compare</span><span class="s4">(</span><span class="s0">value</span><span class="s4">, </span><span class="s0">traits</span><span class="s4">[</span><span class="s0">k</span><span class="s4">].</span><span class="s0">default_value</span><span class="s4">):</span>
<a name="l617"><span class="ln">617  </span></a>                <span class="s0">state</span><span class="s4">[</span><span class="s0">k</span><span class="s4">] = </span><span class="s0">value</span>
<a name="l618"><span class="ln">618  </span></a>        <span class="s3">return </span><span class="s0">state</span>
<a name="l619"><span class="ln">619  </span></a>
<a name="l620"><span class="ln">620  </span></a>    <span class="s3">def </span><span class="s0">_is_numpy</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">x</span><span class="s4">):</span>
<a name="l621"><span class="ln">621  </span></a>        <span class="s3">return </span><span class="s0">x</span><span class="s4">.</span><span class="s0">__class__</span><span class="s4">.</span><span class="s0">__name__ </span><span class="s4">== </span><span class="s5">'ndarray' </span><span class="s3">and </span><span class="s0">x</span><span class="s4">.</span><span class="s0">__class__</span><span class="s4">.</span><span class="s0">__module__ </span><span class="s4">== </span><span class="s5">'numpy'</span>
<a name="l622"><span class="ln">622  </span></a>
<a name="l623"><span class="ln">623  </span></a>    <span class="s3">def </span><span class="s0">_compare</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">a</span><span class="s4">, </span><span class="s0">b</span><span class="s4">):</span>
<a name="l624"><span class="ln">624  </span></a>        <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_is_numpy</span><span class="s4">(</span><span class="s0">a</span><span class="s4">) </span><span class="s3">or </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_is_numpy</span><span class="s4">(</span><span class="s0">b</span><span class="s4">):</span>
<a name="l625"><span class="ln">625  </span></a>            <span class="s3">import </span><span class="s0">numpy </span><span class="s3">as </span><span class="s0">np</span>
<a name="l626"><span class="ln">626  </span></a>            <span class="s3">return </span><span class="s0">np</span><span class="s4">.</span><span class="s0">array_equal</span><span class="s4">(</span><span class="s0">a</span><span class="s4">, </span><span class="s0">b</span><span class="s4">)</span>
<a name="l627"><span class="ln">627  </span></a>        <span class="s3">else</span><span class="s4">:</span>
<a name="l628"><span class="ln">628  </span></a>            <span class="s3">return </span><span class="s0">a </span><span class="s4">== </span><span class="s0">b</span>
<a name="l629"><span class="ln">629  </span></a>
<a name="l630"><span class="ln">630  </span></a>    <span class="s3">def </span><span class="s0">set_state</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">sync_data</span><span class="s4">):</span>
<a name="l631"><span class="ln">631  </span></a>        <span class="s2">&quot;&quot;&quot;Called when a state is received from the front-end.&quot;&quot;&quot;</span>
<a name="l632"><span class="ln">632  </span></a>        <span class="s1"># Send an echo update message immediately</span>
<a name="l633"><span class="ln">633  </span></a>        <span class="s3">if </span><span class="s0">JUPYTER_WIDGETS_ECHO</span><span class="s4">:</span>
<a name="l634"><span class="ln">634  </span></a>            <span class="s0">echo_state </span><span class="s4">= {}</span>
<a name="l635"><span class="ln">635  </span></a>            <span class="s3">for </span><span class="s0">attr</span><span class="s4">, </span><span class="s0">value </span><span class="s3">in </span><span class="s0">sync_data</span><span class="s4">.</span><span class="s0">items</span><span class="s4">():</span>
<a name="l636"><span class="ln">636  </span></a>                <span class="s3">if </span><span class="s0">attr </span><span class="s3">in </span><span class="s0">self</span><span class="s4">.</span><span class="s0">keys </span><span class="s3">and </span><span class="s0">self</span><span class="s4">.</span><span class="s0">trait_metadata</span><span class="s4">(</span><span class="s0">attr</span><span class="s4">, </span><span class="s5">'echo_update'</span><span class="s4">, </span><span class="s0">default</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
<a name="l637"><span class="ln">637  </span></a>                    <span class="s0">echo_state</span><span class="s4">[</span><span class="s0">attr</span><span class="s4">] = </span><span class="s0">value</span>
<a name="l638"><span class="ln">638  </span></a>            <span class="s3">if </span><span class="s0">echo_state</span><span class="s4">:</span>
<a name="l639"><span class="ln">639  </span></a>                <span class="s0">echo_state</span><span class="s4">, </span><span class="s0">echo_buffer_paths</span><span class="s4">, </span><span class="s0">echo_buffers </span><span class="s4">= </span><span class="s0">_remove_buffers</span><span class="s4">(</span><span class="s0">echo_state</span><span class="s4">)</span>
<a name="l640"><span class="ln">640  </span></a>                <span class="s0">msg </span><span class="s4">= {</span>
<a name="l641"><span class="ln">641  </span></a>                    <span class="s5">'method'</span><span class="s4">: </span><span class="s5">'echo_update'</span><span class="s4">,</span>
<a name="l642"><span class="ln">642  </span></a>                    <span class="s5">'state'</span><span class="s4">: </span><span class="s0">echo_state</span><span class="s4">,</span>
<a name="l643"><span class="ln">643  </span></a>                    <span class="s5">'buffer_paths'</span><span class="s4">: </span><span class="s0">echo_buffer_paths</span><span class="s4">,</span>
<a name="l644"><span class="ln">644  </span></a>                <span class="s4">}</span>
<a name="l645"><span class="ln">645  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">_send</span><span class="s4">(</span><span class="s0">msg</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">=</span><span class="s0">echo_buffers</span><span class="s4">)</span>
<a name="l646"><span class="ln">646  </span></a>
<a name="l647"><span class="ln">647  </span></a>        <span class="s1"># The order of these context managers is important. Properties must</span>
<a name="l648"><span class="ln">648  </span></a>        <span class="s1"># be locked when the hold_trait_notification context manager is</span>
<a name="l649"><span class="ln">649  </span></a>        <span class="s1"># released and notifications are fired.</span>
<a name="l650"><span class="ln">650  </span></a>        <span class="s3">with </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_lock_property</span><span class="s4">(**</span><span class="s0">sync_data</span><span class="s4">), </span><span class="s0">self</span><span class="s4">.</span><span class="s0">hold_trait_notifications</span><span class="s4">():</span>
<a name="l651"><span class="ln">651  </span></a>            <span class="s3">for </span><span class="s0">name </span><span class="s3">in </span><span class="s0">sync_data</span><span class="s4">:</span>
<a name="l652"><span class="ln">652  </span></a>                <span class="s3">if </span><span class="s0">name </span><span class="s3">in </span><span class="s0">self</span><span class="s4">.</span><span class="s0">keys</span><span class="s4">:</span>
<a name="l653"><span class="ln">653  </span></a>                    <span class="s0">from_json </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">trait_metadata</span><span class="s4">(</span><span class="s0">name</span><span class="s4">, </span><span class="s5">'from_json'</span><span class="s4">,</span>
<a name="l654"><span class="ln">654  </span></a>                                                    <span class="s0">self</span><span class="s4">.</span><span class="s0">_trait_from_json</span><span class="s4">)</span>
<a name="l655"><span class="ln">655  </span></a>                    <span class="s0">self</span><span class="s4">.</span><span class="s0">set_trait</span><span class="s4">(</span><span class="s0">name</span><span class="s4">, </span><span class="s0">from_json</span><span class="s4">(</span><span class="s0">sync_data</span><span class="s4">[</span><span class="s0">name</span><span class="s4">], </span><span class="s0">self</span><span class="s4">))</span>
<a name="l656"><span class="ln">656  </span></a>
<a name="l657"><span class="ln">657  </span></a>    <span class="s3">def </span><span class="s0">send</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">content</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
<a name="l658"><span class="ln">658  </span></a>        <span class="s2">&quot;&quot;&quot;Sends a custom msg to the widget model in the front-end. 
<a name="l659"><span class="ln">659  </span></a> 
<a name="l660"><span class="ln">660  </span></a>        Parameters 
<a name="l661"><span class="ln">661  </span></a>        ---------- 
<a name="l662"><span class="ln">662  </span></a>        content : dict 
<a name="l663"><span class="ln">663  </span></a>            Content of the message to send. 
<a name="l664"><span class="ln">664  </span></a>        buffers : list of binary buffers 
<a name="l665"><span class="ln">665  </span></a>            Binary buffers to send with message 
<a name="l666"><span class="ln">666  </span></a>        &quot;&quot;&quot;</span>
<a name="l667"><span class="ln">667  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">_send</span><span class="s4">({</span><span class="s5">&quot;method&quot;</span><span class="s4">: </span><span class="s5">&quot;custom&quot;</span><span class="s4">, </span><span class="s5">&quot;content&quot;</span><span class="s4">: </span><span class="s0">content</span><span class="s4">}, </span><span class="s0">buffers</span><span class="s4">=</span><span class="s0">buffers</span><span class="s4">)</span>
<a name="l668"><span class="ln">668  </span></a>
<a name="l669"><span class="ln">669  </span></a>    <span class="s3">def </span><span class="s0">on_msg</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">callback</span><span class="s4">, </span><span class="s0">remove</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
<a name="l670"><span class="ln">670  </span></a>        <span class="s2">&quot;&quot;&quot;(Un)Register a custom msg receive callback. 
<a name="l671"><span class="ln">671  </span></a> 
<a name="l672"><span class="ln">672  </span></a>        Parameters 
<a name="l673"><span class="ln">673  </span></a>        ---------- 
<a name="l674"><span class="ln">674  </span></a>        callback: callable 
<a name="l675"><span class="ln">675  </span></a>            callback will be passed three arguments when a message arrives:: 
<a name="l676"><span class="ln">676  </span></a> 
<a name="l677"><span class="ln">677  </span></a>                callback(widget, content, buffers) 
<a name="l678"><span class="ln">678  </span></a> 
<a name="l679"><span class="ln">679  </span></a>        remove: bool 
<a name="l680"><span class="ln">680  </span></a>            True if the callback should be unregistered.&quot;&quot;&quot;</span>
<a name="l681"><span class="ln">681  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">_msg_callbacks</span><span class="s4">.</span><span class="s0">register_callback</span><span class="s4">(</span><span class="s0">callback</span><span class="s4">, </span><span class="s0">remove</span><span class="s4">=</span><span class="s0">remove</span><span class="s4">)</span>
<a name="l682"><span class="ln">682  </span></a>
<a name="l683"><span class="ln">683  </span></a>    <span class="s3">def </span><span class="s0">add_traits</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, **</span><span class="s0">traits</span><span class="s4">):</span>
<a name="l684"><span class="ln">684  </span></a>        <span class="s2">&quot;&quot;&quot;Dynamically add trait attributes to the Widget.&quot;&quot;&quot;</span>
<a name="l685"><span class="ln">685  </span></a>        <span class="s0">super</span><span class="s4">().</span><span class="s0">add_traits</span><span class="s4">(**</span><span class="s0">traits</span><span class="s4">)</span>
<a name="l686"><span class="ln">686  </span></a>        <span class="s3">for </span><span class="s0">name</span><span class="s4">, </span><span class="s0">trait </span><span class="s3">in </span><span class="s0">traits</span><span class="s4">.</span><span class="s0">items</span><span class="s4">():</span>
<a name="l687"><span class="ln">687  </span></a>            <span class="s3">if </span><span class="s5">'sync' </span><span class="s3">in </span><span class="s0">trait</span><span class="s4">.</span><span class="s0">metadata</span><span class="s4">:</span>
<a name="l688"><span class="ln">688  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">keys</span><span class="s4">.</span><span class="s0">append</span><span class="s4">(</span><span class="s0">name</span><span class="s4">)</span>
<a name="l689"><span class="ln">689  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">send_state</span><span class="s4">(</span><span class="s0">name</span><span class="s4">)</span>
<a name="l690"><span class="ln">690  </span></a>
<a name="l691"><span class="ln">691  </span></a>    <span class="s3">def </span><span class="s0">notify_change</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">change</span><span class="s4">):</span>
<a name="l692"><span class="ln">692  </span></a>        <span class="s2">&quot;&quot;&quot;Called when a property has changed.&quot;&quot;&quot;</span>
<a name="l693"><span class="ln">693  </span></a>        <span class="s1"># Send the state to the frontend before the user-registered callbacks</span>
<a name="l694"><span class="ln">694  </span></a>        <span class="s1"># are called.</span>
<a name="l695"><span class="ln">695  </span></a>        <span class="s0">name </span><span class="s4">= </span><span class="s0">change</span><span class="s4">[</span><span class="s5">'name'</span><span class="s4">]</span>
<a name="l696"><span class="ln">696  </span></a>        <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">comm </span><span class="s3">is not None and </span><span class="s0">getattr</span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">comm</span><span class="s4">, </span><span class="s5">'kernel'</span><span class="s4">, </span><span class="s3">True</span><span class="s4">) </span><span class="s3">is not None</span><span class="s4">:</span>
<a name="l697"><span class="ln">697  </span></a>            <span class="s1"># Make sure this isn't information that the front-end just sent us.</span>
<a name="l698"><span class="ln">698  </span></a>            <span class="s3">if </span><span class="s0">name </span><span class="s3">in </span><span class="s0">self</span><span class="s4">.</span><span class="s0">keys </span><span class="s3">and </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_should_send_property</span><span class="s4">(</span><span class="s0">name</span><span class="s4">, </span><span class="s0">getattr</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">name</span><span class="s4">)):</span>
<a name="l699"><span class="ln">699  </span></a>                <span class="s1"># Send new state to front-end</span>
<a name="l700"><span class="ln">700  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">send_state</span><span class="s4">(</span><span class="s0">key</span><span class="s4">=</span><span class="s0">name</span><span class="s4">)</span>
<a name="l701"><span class="ln">701  </span></a>        <span class="s0">super</span><span class="s4">().</span><span class="s0">notify_change</span><span class="s4">(</span><span class="s0">change</span><span class="s4">)</span>
<a name="l702"><span class="ln">702  </span></a>
<a name="l703"><span class="ln">703  </span></a>    <span class="s3">def </span><span class="s0">__repr__</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l704"><span class="ln">704  </span></a>        <span class="s3">return </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_gen_repr_from_keys</span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">_repr_keys</span><span class="s4">())</span>
<a name="l705"><span class="ln">705  </span></a>
<a name="l706"><span class="ln">706  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l707"><span class="ln">707  </span></a>    <span class="s1"># Support methods</span>
<a name="l708"><span class="ln">708  </span></a>    <span class="s1">#-------------------------------------------------------------------------</span>
<a name="l709"><span class="ln">709  </span></a>
<a name="l710"><span class="ln">710  </span></a>    <span class="s4">@</span><span class="s0">contextmanager</span>
<a name="l711"><span class="ln">711  </span></a>    <span class="s3">def </span><span class="s0">_lock_property</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, **</span><span class="s0">properties</span><span class="s4">):</span>
<a name="l712"><span class="ln">712  </span></a>        <span class="s2">&quot;&quot;&quot;Lock a property-value pair. 
<a name="l713"><span class="ln">713  </span></a> 
<a name="l714"><span class="ln">714  </span></a>        The value should be the JSON state of the property. 
<a name="l715"><span class="ln">715  </span></a> 
<a name="l716"><span class="ln">716  </span></a>        NOTE: This, in addition to the single lock for all state changes, is 
<a name="l717"><span class="ln">717  </span></a>        flawed.  In the future we may want to look into buffering state changes 
<a name="l718"><span class="ln">718  </span></a>        back to the front-end.&quot;&quot;&quot;</span>
<a name="l719"><span class="ln">719  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">_property_lock </span><span class="s4">= </span><span class="s0">properties</span>
<a name="l720"><span class="ln">720  </span></a>        <span class="s3">try</span><span class="s4">:</span>
<a name="l721"><span class="ln">721  </span></a>            <span class="s3">yield</span>
<a name="l722"><span class="ln">722  </span></a>        <span class="s3">finally</span><span class="s4">:</span>
<a name="l723"><span class="ln">723  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">_property_lock </span><span class="s4">= {}</span>
<a name="l724"><span class="ln">724  </span></a>
<a name="l725"><span class="ln">725  </span></a>    <span class="s4">@</span><span class="s0">contextmanager</span>
<a name="l726"><span class="ln">726  </span></a>    <span class="s3">def </span><span class="s0">hold_sync</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l727"><span class="ln">727  </span></a>        <span class="s2">&quot;&quot;&quot;Hold syncing any state until the outermost context manager exits&quot;&quot;&quot;</span>
<a name="l728"><span class="ln">728  </span></a>        <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_holding_sync </span><span class="s3">is True</span><span class="s4">:</span>
<a name="l729"><span class="ln">729  </span></a>            <span class="s3">yield</span>
<a name="l730"><span class="ln">730  </span></a>        <span class="s3">else</span><span class="s4">:</span>
<a name="l731"><span class="ln">731  </span></a>            <span class="s3">try</span><span class="s4">:</span>
<a name="l732"><span class="ln">732  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">_holding_sync </span><span class="s4">= </span><span class="s3">True</span>
<a name="l733"><span class="ln">733  </span></a>                <span class="s3">yield</span>
<a name="l734"><span class="ln">734  </span></a>            <span class="s3">finally</span><span class="s4">:</span>
<a name="l735"><span class="ln">735  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">_holding_sync </span><span class="s4">= </span><span class="s3">False</span>
<a name="l736"><span class="ln">736  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">send_state</span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">_states_to_send</span><span class="s4">)</span>
<a name="l737"><span class="ln">737  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">_states_to_send</span><span class="s4">.</span><span class="s0">clear</span><span class="s4">()</span>
<a name="l738"><span class="ln">738  </span></a>
<a name="l739"><span class="ln">739  </span></a>    <span class="s3">def </span><span class="s0">_should_send_property</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">key</span><span class="s4">, </span><span class="s0">value</span><span class="s4">):</span>
<a name="l740"><span class="ln">740  </span></a>        <span class="s2">&quot;&quot;&quot;Check the property lock (property_lock)&quot;&quot;&quot;</span>
<a name="l741"><span class="ln">741  </span></a>        <span class="s0">to_json </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">trait_metadata</span><span class="s4">(</span><span class="s0">key</span><span class="s4">, </span><span class="s5">'to_json'</span><span class="s4">, </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_trait_to_json</span><span class="s4">)</span>
<a name="l742"><span class="ln">742  </span></a>        <span class="s3">if </span><span class="s0">key </span><span class="s3">in </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_property_lock</span><span class="s4">:</span>
<a name="l743"><span class="ln">743  </span></a>            <span class="s1"># model_state, buffer_paths, buffers</span>
<a name="l744"><span class="ln">744  </span></a>            <span class="s0">split_value </span><span class="s4">= </span><span class="s0">_remove_buffers</span><span class="s4">({ </span><span class="s0">key</span><span class="s4">: </span><span class="s0">to_json</span><span class="s4">(</span><span class="s0">value</span><span class="s4">, </span><span class="s0">self</span><span class="s4">)})</span>
<a name="l745"><span class="ln">745  </span></a>            <span class="s0">split_lock </span><span class="s4">= </span><span class="s0">_remove_buffers</span><span class="s4">({ </span><span class="s0">key</span><span class="s4">: </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_property_lock</span><span class="s4">[</span><span class="s0">key</span><span class="s4">]})</span>
<a name="l746"><span class="ln">746  </span></a>            <span class="s1"># A roundtrip conversion through json in the comparison takes care of</span>
<a name="l747"><span class="ln">747  </span></a>            <span class="s1"># idiosyncracies of how python data structures map to json, for example</span>
<a name="l748"><span class="ln">748  </span></a>            <span class="s1"># tuples get converted to lists.</span>
<a name="l749"><span class="ln">749  </span></a>            <span class="s3">if </span><span class="s4">(</span><span class="s0">jsonloads</span><span class="s4">(</span><span class="s0">jsondumps</span><span class="s4">(</span><span class="s0">split_value</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])) == </span><span class="s0">split_lock</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
<a name="l750"><span class="ln">750  </span></a>                <span class="s3">and </span><span class="s0">split_value</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] == </span><span class="s0">split_lock</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
<a name="l751"><span class="ln">751  </span></a>                <span class="s3">and </span><span class="s0">_buffer_list_equal</span><span class="s4">(</span><span class="s0">split_value</span><span class="s4">[</span><span class="s6">2</span><span class="s4">], </span><span class="s0">split_lock</span><span class="s4">[</span><span class="s6">2</span><span class="s4">])):</span>
<a name="l752"><span class="ln">752  </span></a>                <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_holding_sync</span><span class="s4">:</span>
<a name="l753"><span class="ln">753  </span></a>                    <span class="s0">self</span><span class="s4">.</span><span class="s0">_states_to_send</span><span class="s4">.</span><span class="s0">discard</span><span class="s4">(</span><span class="s0">key</span><span class="s4">)</span>
<a name="l754"><span class="ln">754  </span></a>                <span class="s3">return False</span>
<a name="l755"><span class="ln">755  </span></a>        <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_holding_sync</span><span class="s4">:</span>
<a name="l756"><span class="ln">756  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">_states_to_send</span><span class="s4">.</span><span class="s0">add</span><span class="s4">(</span><span class="s0">key</span><span class="s4">)</span>
<a name="l757"><span class="ln">757  </span></a>            <span class="s3">return False</span>
<a name="l758"><span class="ln">758  </span></a>        <span class="s3">else</span><span class="s4">:</span>
<a name="l759"><span class="ln">759  </span></a>            <span class="s3">return True</span>
<a name="l760"><span class="ln">760  </span></a>
<a name="l761"><span class="ln">761  </span></a>    <span class="s1"># Event handlers</span>
<a name="l762"><span class="ln">762  </span></a>    <span class="s4">@</span><span class="s0">_show_traceback</span>
<a name="l763"><span class="ln">763  </span></a>    <span class="s3">def </span><span class="s0">_handle_msg</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">msg</span><span class="s4">):</span>
<a name="l764"><span class="ln">764  </span></a>        <span class="s2">&quot;&quot;&quot;Called when a msg is received from the front-end&quot;&quot;&quot;</span>
<a name="l765"><span class="ln">765  </span></a>        <span class="s0">data </span><span class="s4">= </span><span class="s0">msg</span><span class="s4">[</span><span class="s5">'content'</span><span class="s4">][</span><span class="s5">'data'</span><span class="s4">]</span>
<a name="l766"><span class="ln">766  </span></a>        <span class="s0">method </span><span class="s4">= </span><span class="s0">data</span><span class="s4">[</span><span class="s5">'method'</span><span class="s4">]</span>
<a name="l767"><span class="ln">767  </span></a>
<a name="l768"><span class="ln">768  </span></a>        <span class="s3">if </span><span class="s0">method </span><span class="s4">== </span><span class="s5">'update'</span><span class="s4">:</span>
<a name="l769"><span class="ln">769  </span></a>            <span class="s3">if </span><span class="s5">'state' </span><span class="s3">in </span><span class="s0">data</span><span class="s4">:</span>
<a name="l770"><span class="ln">770  </span></a>                <span class="s0">state </span><span class="s4">= </span><span class="s0">data</span><span class="s4">[</span><span class="s5">'state'</span><span class="s4">]</span>
<a name="l771"><span class="ln">771  </span></a>                <span class="s3">if </span><span class="s5">'buffer_paths' </span><span class="s3">in </span><span class="s0">data</span><span class="s4">:</span>
<a name="l772"><span class="ln">772  </span></a>                    <span class="s0">_put_buffers</span><span class="s4">(</span><span class="s0">state</span><span class="s4">, </span><span class="s0">data</span><span class="s4">[</span><span class="s5">'buffer_paths'</span><span class="s4">], </span><span class="s0">msg</span><span class="s4">[</span><span class="s5">'buffers'</span><span class="s4">])</span>
<a name="l773"><span class="ln">773  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">set_state</span><span class="s4">(</span><span class="s0">state</span><span class="s4">)</span>
<a name="l774"><span class="ln">774  </span></a>
<a name="l775"><span class="ln">775  </span></a>        <span class="s1"># Handle a state request.</span>
<a name="l776"><span class="ln">776  </span></a>        <span class="s3">elif </span><span class="s0">method </span><span class="s4">== </span><span class="s5">'request_state'</span><span class="s4">:</span>
<a name="l777"><span class="ln">777  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">send_state</span><span class="s4">()</span>
<a name="l778"><span class="ln">778  </span></a>
<a name="l779"><span class="ln">779  </span></a>        <span class="s1"># Handle a custom msg from the front-end.</span>
<a name="l780"><span class="ln">780  </span></a>        <span class="s3">elif </span><span class="s0">method </span><span class="s4">== </span><span class="s5">'custom'</span><span class="s4">:</span>
<a name="l781"><span class="ln">781  </span></a>            <span class="s3">if </span><span class="s5">'content' </span><span class="s3">in </span><span class="s0">data</span><span class="s4">:</span>
<a name="l782"><span class="ln">782  </span></a>                <span class="s0">self</span><span class="s4">.</span><span class="s0">_handle_custom_msg</span><span class="s4">(</span><span class="s0">data</span><span class="s4">[</span><span class="s5">'content'</span><span class="s4">], </span><span class="s0">msg</span><span class="s4">[</span><span class="s5">'buffers'</span><span class="s4">])</span>
<a name="l783"><span class="ln">783  </span></a>
<a name="l784"><span class="ln">784  </span></a>        <span class="s1"># Catch remainder.</span>
<a name="l785"><span class="ln">785  </span></a>        <span class="s3">else</span><span class="s4">:</span>
<a name="l786"><span class="ln">786  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">log</span><span class="s4">.</span><span class="s0">error</span><span class="s4">(</span><span class="s5">'Unknown front-end to back-end widget msg with method &quot;%s&quot;' </span><span class="s4">% </span><span class="s0">method</span><span class="s4">)</span>
<a name="l787"><span class="ln">787  </span></a>
<a name="l788"><span class="ln">788  </span></a>    <span class="s3">def </span><span class="s0">_handle_custom_msg</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">content</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">):</span>
<a name="l789"><span class="ln">789  </span></a>        <span class="s2">&quot;&quot;&quot;Called when a custom msg is received.&quot;&quot;&quot;</span>
<a name="l790"><span class="ln">790  </span></a>        <span class="s0">self</span><span class="s4">.</span><span class="s0">_msg_callbacks</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">content</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">)</span>
<a name="l791"><span class="ln">791  </span></a>
<a name="l792"><span class="ln">792  </span></a>    <span class="s4">@</span><span class="s0">staticmethod</span>
<a name="l793"><span class="ln">793  </span></a>    <span class="s3">def </span><span class="s0">_trait_to_json</span><span class="s4">(</span><span class="s0">x</span><span class="s4">, </span><span class="s0">self</span><span class="s4">):</span>
<a name="l794"><span class="ln">794  </span></a>        <span class="s2">&quot;&quot;&quot;Convert a trait value to json.&quot;&quot;&quot;</span>
<a name="l795"><span class="ln">795  </span></a>        <span class="s3">return </span><span class="s0">x</span>
<a name="l796"><span class="ln">796  </span></a>
<a name="l797"><span class="ln">797  </span></a>    <span class="s4">@</span><span class="s0">staticmethod</span>
<a name="l798"><span class="ln">798  </span></a>    <span class="s3">def </span><span class="s0">_trait_from_json</span><span class="s4">(</span><span class="s0">x</span><span class="s4">, </span><span class="s0">self</span><span class="s4">):</span>
<a name="l799"><span class="ln">799  </span></a>        <span class="s2">&quot;&quot;&quot;Convert json values to objects.&quot;&quot;&quot;</span>
<a name="l800"><span class="ln">800  </span></a>        <span class="s3">return </span><span class="s0">x</span>
<a name="l801"><span class="ln">801  </span></a>
<a name="l802"><span class="ln">802  </span></a>    <span class="s3">def </span><span class="s0">_repr_mimebundle_</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, **</span><span class="s0">kwargs</span><span class="s4">):</span>
<a name="l803"><span class="ln">803  </span></a>        <span class="s0">plaintext </span><span class="s4">= </span><span class="s0">repr</span><span class="s4">(</span><span class="s0">self</span><span class="s4">)</span>
<a name="l804"><span class="ln">804  </span></a>        <span class="s3">if </span><span class="s0">len</span><span class="s4">(</span><span class="s0">plaintext</span><span class="s4">) &gt; </span><span class="s6">110</span><span class="s4">:</span>
<a name="l805"><span class="ln">805  </span></a>            <span class="s0">plaintext </span><span class="s4">= </span><span class="s0">plaintext</span><span class="s4">[:</span><span class="s6">110</span><span class="s4">] + </span><span class="s5">''</span>
<a name="l806"><span class="ln">806  </span></a>        <span class="s0">data </span><span class="s4">= {</span>
<a name="l807"><span class="ln">807  </span></a>            <span class="s5">'text/plain'</span><span class="s4">: </span><span class="s0">plaintext</span><span class="s4">,</span>
<a name="l808"><span class="ln">808  </span></a>        <span class="s4">}</span>
<a name="l809"><span class="ln">809  </span></a>        <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_view_name </span><span class="s3">is not None</span><span class="s4">:</span>
<a name="l810"><span class="ln">810  </span></a>            <span class="s1"># The 'application/vnd.jupyter.widget-view+json' mimetype has not been registered yet.</span>
<a name="l811"><span class="ln">811  </span></a>            <span class="s1"># See the registration process and naming convention at</span>
<a name="l812"><span class="ln">812  </span></a>            <span class="s1"># http://tools.ietf.org/html/rfc6838</span>
<a name="l813"><span class="ln">813  </span></a>            <span class="s1"># and the currently registered mimetypes at</span>
<a name="l814"><span class="ln">814  </span></a>            <span class="s1"># http://www.iana.org/assignments/media-types/media-types.xhtml.</span>
<a name="l815"><span class="ln">815  </span></a>            <span class="s0">data</span><span class="s4">[</span><span class="s5">'application/vnd.jupyter.widget-view+json'</span><span class="s4">] = {</span>
<a name="l816"><span class="ln">816  </span></a>                <span class="s5">'version_major'</span><span class="s4">: </span><span class="s6">2</span><span class="s4">,</span>
<a name="l817"><span class="ln">817  </span></a>                <span class="s5">'version_minor'</span><span class="s4">: </span><span class="s6">0</span><span class="s4">,</span>
<a name="l818"><span class="ln">818  </span></a>                <span class="s5">'model_id'</span><span class="s4">: </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_model_id</span>
<a name="l819"><span class="ln">819  </span></a>            <span class="s4">}</span>
<a name="l820"><span class="ln">820  </span></a>            <span class="s3">return </span><span class="s0">data</span>
<a name="l821"><span class="ln">821  </span></a>
<a name="l822"><span class="ln">822  </span></a>    <span class="s3">def </span><span class="s0">_send</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">msg</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
<a name="l823"><span class="ln">823  </span></a>        <span class="s2">&quot;&quot;&quot;Sends a message to the model in the front-end.&quot;&quot;&quot;</span>
<a name="l824"><span class="ln">824  </span></a>        <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">comm </span><span class="s3">is not None and </span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">comm</span><span class="s4">.</span><span class="s0">kernel </span><span class="s3">is not None if </span><span class="s0">hasattr</span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">comm</span><span class="s4">, </span><span class="s5">&quot;kernel&quot;</span><span class="s4">) </span><span class="s3">else True</span><span class="s4">):</span>
<a name="l825"><span class="ln">825  </span></a>            <span class="s0">self</span><span class="s4">.</span><span class="s0">comm</span><span class="s4">.</span><span class="s0">send</span><span class="s4">(</span><span class="s0">data</span><span class="s4">=</span><span class="s0">msg</span><span class="s4">, </span><span class="s0">buffers</span><span class="s4">=</span><span class="s0">buffers</span><span class="s4">)</span>
<a name="l826"><span class="ln">826  </span></a>
<a name="l827"><span class="ln">827  </span></a>    <span class="s3">def </span><span class="s0">_repr_keys</span><span class="s4">(</span><span class="s0">self</span><span class="s4">):</span>
<a name="l828"><span class="ln">828  </span></a>        <span class="s0">traits </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">traits</span><span class="s4">()</span>
<a name="l829"><span class="ln">829  </span></a>        <span class="s3">for </span><span class="s0">key </span><span class="s3">in </span><span class="s0">sorted</span><span class="s4">(</span><span class="s0">self</span><span class="s4">.</span><span class="s0">keys</span><span class="s4">):</span>
<a name="l830"><span class="ln">830  </span></a>            <span class="s1"># Exclude traits that start with an underscore</span>
<a name="l831"><span class="ln">831  </span></a>            <span class="s3">if </span><span class="s0">key</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">'_'</span><span class="s4">:</span>
<a name="l832"><span class="ln">832  </span></a>                <span class="s3">continue</span>
<a name="l833"><span class="ln">833  </span></a>            <span class="s1"># Exclude traits who are equal to their default value</span>
<a name="l834"><span class="ln">834  </span></a>            <span class="s0">value </span><span class="s4">= </span><span class="s0">getattr</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">key</span><span class="s4">)</span>
<a name="l835"><span class="ln">835  </span></a>            <span class="s0">trait </span><span class="s4">= </span><span class="s0">traits</span><span class="s4">[</span><span class="s0">key</span><span class="s4">]</span>
<a name="l836"><span class="ln">836  </span></a>            <span class="s3">if </span><span class="s0">self</span><span class="s4">.</span><span class="s0">_compare</span><span class="s4">(</span><span class="s0">value</span><span class="s4">, </span><span class="s0">trait</span><span class="s4">.</span><span class="s0">default_value</span><span class="s4">):</span>
<a name="l837"><span class="ln">837  </span></a>                <span class="s3">continue</span>
<a name="l838"><span class="ln">838  </span></a>            <span class="s3">elif </span><span class="s4">(</span><span class="s0">isinstance</span><span class="s4">(</span><span class="s0">trait</span><span class="s4">, (</span><span class="s0">Container</span><span class="s4">, </span><span class="s0">Dict</span><span class="s4">)) </span><span class="s3">and</span>
<a name="l839"><span class="ln">839  </span></a>                  <span class="s0">trait</span><span class="s4">.</span><span class="s0">default_value </span><span class="s4">== </span><span class="s0">Undefined </span><span class="s3">and</span>
<a name="l840"><span class="ln">840  </span></a>                  <span class="s4">(</span><span class="s0">value </span><span class="s3">is None or </span><span class="s0">len</span><span class="s4">(</span><span class="s0">value</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">)):</span>
<a name="l841"><span class="ln">841  </span></a>                <span class="s1"># Empty container, and dynamic default will be empty</span>
<a name="l842"><span class="ln">842  </span></a>                <span class="s3">continue</span>
<a name="l843"><span class="ln">843  </span></a>            <span class="s3">yield </span><span class="s0">key</span>
<a name="l844"><span class="ln">844  </span></a>
<a name="l845"><span class="ln">845  </span></a>    <span class="s3">def </span><span class="s0">_gen_repr_from_keys</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">keys</span><span class="s4">):</span>
<a name="l846"><span class="ln">846  </span></a>        <span class="s0">class_name </span><span class="s4">= </span><span class="s0">self</span><span class="s4">.</span><span class="s0">__class__</span><span class="s4">.</span><span class="s0">__name__</span>
<a name="l847"><span class="ln">847  </span></a>        <span class="s0">signature </span><span class="s4">= </span><span class="s5">', '</span><span class="s4">.</span><span class="s0">join</span><span class="s4">(</span>
<a name="l848"><span class="ln">848  </span></a>            <span class="s5">'{}={!r}'</span><span class="s4">.</span><span class="s0">format</span><span class="s4">(</span><span class="s0">key</span><span class="s4">, </span><span class="s0">getattr</span><span class="s4">(</span><span class="s0">self</span><span class="s4">, </span><span class="s0">key</span><span class="s4">))</span>
<a name="l849"><span class="ln">849  </span></a>            <span class="s3">for </span><span class="s0">key </span><span class="s3">in </span><span class="s0">keys</span>
<a name="l850"><span class="ln">850  </span></a>        <span class="s4">)</span>
<a name="l851"><span class="ln">851  </span></a>        <span class="s3">return </span><span class="s5">'{}({})'</span><span class="s4">.</span><span class="s0">format</span><span class="s4">(</span><span class="s0">class_name</span><span class="s4">, </span><span class="s0">signature</span><span class="s4">)</span>
<a name="l852"><span class="ln">852  </span></a></pre>
</body>
</html>